<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة جدوى مشروع تربية الأغنام - مصر</title>
    <style>
        /* Chart.js styling */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 15px 0;
        }
        
        .chart-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .chart-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* Data management controls */
        .data-controls {
            background: #34495e;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .data-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .data-controls button:hover {
            background: #2980b9;
        }
        
        .data-controls input[type="file"] {
            display: none;
        }
        
        /* Export modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            direction: rtl;
        }
        
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        /* Print styles */
        @media print {
            .tabs, .data-controls {
                display: none;
            }
            
            .tab-content {
                display: block !important;
                page-break-inside: avoid;
            }
            
            .chart-container {
                height: 200px;
            }
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
            direction: rtl;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow-x: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: -1px;
            justify-content: stretch;
            flex-wrap: nowrap;
        }
        
        .tab {
            flex: 1 1 auto;
            min-width: 0;
            padding: 5px 2px;
            text-align: center;
            cursor: pointer;
            background: #ecf0f1;
            border: none;
            border-right: 1px solid #bdc3c7;
            font-size: 0.65rem;
            font-weight: bold;
            transition: all 0.3s;
            white-space: normal;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 35px;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 3px solid #3498db;
            font-weight: bold;
            border-right-color: transparent;
        }
        
        .tab.active + .tab {
            border-left: 1px solid transparent;
        }
        
        .tab:hover {
            background: #d5dbdb;
            position: relative;
            z-index: 1;
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 10px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 6px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 6px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #e9ecef;
        }
        
        .section h3 {
            color: #495057;
            margin-bottom: 6px;
            font-size: 0.95rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 3px;
        }
        
        .input-group {
            margin-bottom: 6px;
        }
        
        .input-group-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        label {
            display: block;
            margin-bottom: 3px;
            color: #555;
            font-weight: 500;
            font-size: 0.7rem;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            transition: border-color 0.3s;
            direction: ltr;
            text-align: right;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .result {
            background: #e8f4f8;
            padding: 6px 8px;
            border-radius: 4px;
            margin-top: 6px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.85rem;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .summary-section h2 {
            color: white;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.3rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .metric {
            background: rgba(255,255,255,0.15);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.85rem;
            margin-bottom: 6px;
            opacity: 0.9;
        }
        
        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .decision-box {
            text-align: center;
            padding: 10px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .decision-box.go {
            background: #27ae60;
            color: white;
        }
        
        .decision-box.no-go {
            background: #e74c3c;
            color: white;
        }
        
        .decision-box.maybe {
            background: #f39c12;
            color: white;
        }
        
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffecc0;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            color: #856404;
            font-size: 0.8rem;
        }
        
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 4px;
        }
        
        .compact-input {
            display: flex;
            flex-direction: column;
        }
        
        .compact-input label {
            font-size: 0.65rem;
            margin-bottom: 2px;
        }
        
        .compact-input input, .compact-input select {
            padding: 4px;
            font-size: 11px;
        }
        
        .section-compact {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px;
            border: 1px solid #e9ecef;
        }
        
        .section-compact h3 {
            font-size: 0.9rem;
            margin-bottom: 6px;
            padding-bottom: 3px;
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .stat-box {
            background: #3498db;
            color: white;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 1rem;
            font-weight: bold;
        }
        
        .stat-box .label {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .small-text {
            font-size: 0.65rem;
            color: #777;
            display: block;
            margin-top: 2px;
        }
        
        @media (max-width: 768px) {
            .tab {
                font-size: 0.6rem;
                padding: 4px 2px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .tab {
                font-size: 0.65rem;
                padding: 5px 2px;
            }
        }
        
        @media (min-width: 1025px) and (max-width: 1200px) {
            .tab {
                font-size: 0.7rem;
                padding: 6px 3px;
            }
        }
        
        @media (min-width: 1201px) {
            .tab {
                font-size: 0.75rem;
                padding: 8px 4px;
            }
            
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-3 {
                grid-template-columns: repeat(3, 1fr);
            }
            .grid-4 {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 1401px) {
            .tab {
                font-size: 0.8rem;
                padding: 10px 5px;
            }
        }
    </style>
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>🐑 حاسبة جدوى مشروع تربية الأغنام - مصر</h1>
        
        <!-- Data Management Controls -->
        <div class="data-controls">
            <button onclick="saveProject()">💾 حفظ المشروع</button>
            <button onclick="document.getElementById('loadFile').click()">📂 تحميل مشروع</button>
            <input type="file" id="loadFile" accept=".json" onchange="loadProject(event)">
            <button onclick="exportToPDF()">📄 تصدير PDF</button>
            <button onclick="exportToExcel()">📊 تصدير Excel</button>
            <button onclick="window.print()">🖨️ طباعة</button>
            <button onclick="showModal('reportModal')">📈 تقرير مفصل</button>
        </div>
        
        <!-- Quick Summary Dashboard -->
        <div id="quickSummary" style="background: #2c3e50; color: white; padding: 8px; border-radius: 6px; margin-bottom: 10px; display: none;">
            <div class="quick-stats">
                <div class="stat-box" style="background: #27ae60;">
                    <div class="value" id="quickProfit">0</div>
                    <div class="label">صافي الربح</div>
                </div>
                <div class="stat-box" style="background: #e74c3c;">
                    <div class="value" id="quickInvestment">0</div>
                    <div class="label">الاستثمار</div>
                </div>
                <div class="stat-box" style="background: #f39c12;">
                    <div class="value" id="quickROI">0%</div>
                    <div class="label">العائد</div>
                </div>
                <div class="stat-box" style="background: #9b59b6;">
                    <div class="value" id="quickBreakeven">0</div>
                    <div class="label">التعادل/شهر</div>
                </div>
                <div class="stat-box" style="background: #34495e;">
                    <div class="value" id="quickRevenue">0</div>
                    <div class="label">الإيرادات</div>
                </div>
                <div class="stat-box" style="background: #16a085;">
                    <div class="value" id="quickMargin">0%</div>
                    <div class="label">هامش الربح</div>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('market')">بحث السوق</button>
            <button class="tab" onclick="showTab('livestock')">بيانات الأغنام</button>
            <button class="tab" onclick="showTab('infrastructure')">البنية التحتية</button>
            <button class="tab" onclick="showTab('operations')">التشغيل</button>
            <button class="tab" onclick="showTab('breeding')">برنامج التربية</button>
            <button class="tab" onclick="showTab('risks')">المخاطر والضرائب</button>
            <button class="tab" onclick="showTab('seasonal')">التحليل الموسمي</button>
            <button class="tab" onclick="showTab('financial')">التحليل المالي</button>
            <button class="tab" onclick="showTab('multiyear')">التخطيط متعدد السنوات</button>
            <button class="tab" onclick="showTab('feedOptimizer')">محسن الأعلاف</button>
            <button class="tab" onclick="showTab('breedingCalendar')">تقويم التربية</button>
            <button class="tab" onclick="showTab('sensitivity')">تحليل الحساسية</button>
            <button class="tab" onclick="showTab('marketIntel')">ذكاء السوق</button>
            <button class="tab" onclick="showTab('compliance')">الالتزامات</button>
            <button class="tab" onclick="showTab('operations')">أدوات تشغيلية</button>
        </div>
        
        <!-- بحث السوق -->
        <div id="market" class="tab-content active">
            <div class="info-box">
                📊 ادخل معلومات السوق المحلية لمنطقتك للحصول على تحليل دقيق
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>أسعار البيع</h3>
                    <div class="input-group">
                        <label>سعر خروف الأضحية (جنيه)</label>
                        <input type="number" id="udheyaPrice" value="8000">
                        <span class="small-text">متوسط السعر في موسم الأضحى</span>
                    </div>
                    <div class="input-group">
                        <label>سعر كيلو اللحم (جنيه)</label>
                        <input type="number" id="meatPrice" value="250">
                    </div>
                    <div class="input-group">
                        <label>سعر الخروف الحي للبيع (جنيه)</label>
                        <input type="number" id="liveAnimalPrice" value="6000">
                        <span class="small-text">للمناسبات والأفراح</span>
                    </div>
                    <div class="input-group">
                        <label>سعر وجبة الكاترينج/شخص (جنيه)</label>
                        <input type="number" id="cateringPrice" value="150">
                    </div>
                    <div class="input-group">
                        <label>سعر إيجار الخروف للمناسبات (جنيه/يوم)</label>
                        <input type="number" id="eventRentalPrice" value="500">
                    </div>
                    <div class="input-group">
                        <label>سعر بيع السماد العضوي/طن</label>
                        <input type="number" id="manurePrice" value="300">
                    </div>
                    <div class="input-group">
                        <label>سعر بيع الجلد/قطعة</label>
                        <input type="number" id="hidePrice" value="150">
                    </div>
                    <div class="input-group">
                        <label>سعر التصدير للخليج/خروف</label>
                        <input type="number" id="exportPrice" value="12000">
                    </div>
                </div>
                
                <div class="section">
                    <h3>معلومات السوق</h3>
                    <div class="input-group">
                        <label>نوع السوق المستهدف</label>
                        <select id="marketType">
                            <option value="local">محلي</option>
                            <option value="regional">إقليمي</option>
                            <option value="online">أونلاين</option>
                            <option value="mixed">مختلط</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>متوسط سعر المنافسين (خروف أضحية)</label>
                        <input type="number" id="competitorPrice" value="7500">
                    </div>
                    <div class="input-group">
                        <label>عدد المنافسين في المنطقة</label>
                        <input type="number" id="competitors" value="5">
                    </div>
                    <div class="input-group">
                        <label>نسبة العملاء النقدي (%)</label>
                        <input type="number" id="cashCustomers" value="60">
                    </div>
                    <div class="input-group">
                        <label>نسبة العملاء الآجل (%)</label>
                        <input type="number" id="creditCustomers" value="40" readonly>
                    </div>
                    <div class="input-group">
                        <label>متوسط فترة التحصيل (يوم)</label>
                        <input type="number" id="collectionPeriod" value="30">
                    </div>
                    <div class="input-group">
                        <label>نسبة اللحوم الممتازة (%)</label>
                        <input type="number" id="premiumMeat" value="30">
                    </div>
                    <div class="input-group">
                        <label>نسبة اللحوم الجيدة (%)</label>
                        <input type="number" id="goodMeat" value="50">
                    </div>
                    <div class="input-group">
                        <label>نسبة اللحوم العادية (%)</label>
                        <input type="number" id="regularMeat" value="20">
                    </div>
                </div>
                
                <div class="section">
                    <h3>تحليل الطلب</h3>
                    <div class="input-group">
                        <label>عدد العملاء المتوقع (أضاحي)</label>
                        <input type="number" id="udheyaCustomers" value="100">
                    </div>
                    <div class="input-group">
                        <label>كمية اللحم المطلوبة شهرياً (كيلو)</label>
                        <input type="number" id="meatDemand" value="500">
                    </div>
                    <div class="input-group">
                        <label>عدد الخراف الحية للبيع شهرياً</label>
                        <input type="number" id="liveAnimalMonthly" value="10">
                    </div>
                    <div class="input-group">
                        <label>عدد مناسبات الكاترينج شهرياً</label>
                        <input type="number" id="cateringEvents" value="4">
                    </div>
                    <div class="input-group">
                        <label>متوسط عدد الأشخاص/مناسبة كاترينج</label>
                        <input type="number" id="cateringPeople" value="50">
                    </div>
                    <div class="input-group">
                        <label>عدد إيجارات المناسبات شهرياً</label>
                        <input type="number" id="eventRentals" value="3">
                    </div>
                    <div class="input-group">
                        <label>عدد الخراف للتصدير شهرياً</label>
                        <input type="number" id="exportMonthly" value="5">
                    </div>
                    <div class="input-group">
                        <label>إنتاج السماد العضوي (طن/سنة)</label>
                        <input type="number" id="manureProduction" value="20">
                    </div>
                </div>
                
                <div class="section">
                    <h3>معدات الكاترينج والمناسبات</h3>
                    <div class="input-group">
                        <label>شوايات ومعدات طبخ</label>
                        <input type="number" id="cateringCooking" value="30000">
                    </div>
                    <div class="input-group">
                        <label>خيام وكراسي وطاولات</label>
                        <input type="number" id="cateringFurniture" value="40000">
                    </div>
                    <div class="input-group">
                        <label>أطباق وأدوات تقديم</label>
                        <input type="number" id="cateringServing" value="15000">
                    </div>
                    <div class="input-group">
                        <label>مولد كهرباء متنقل</label>
                        <input type="number" id="generator" value="25000">
                    </div>
                    <div class="input-group">
                        <label>تصوير احترافي للمنتجات</label>
                        <input type="number" id="photography" value="5000">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- بيانات الأغنام -->
        <div id="livestock" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h3>شراء الأغنام</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>عدد الأغنام المبدئي</label>
                            <input type="number" id="initialSheep" value="50">
                        </div>
                        <div class="input-group">
                            <label>سعر الخروف (جنيه)</label>
                            <input type="number" id="sheepCost" value="3500">
                        </div>
                        <div class="input-group">
                            <label>عدد النعاج</label>
                            <input type="number" id="ewes" value="30">
                        </div>
                        <div class="input-group">
                            <label>عدد الكباش</label>
                            <input type="number" id="rams" value="3">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>معدلات الإنتاج</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>معدل الولادة %</label>
                            <input type="number" id="birthRate" value="150">
                            <span class="small-text">150% = 1.5 مولود/نعجة</span>
                        </div>
                        <div class="input-group">
                            <label>معدل النفوق %</label>
                            <input type="number" id="mortalityRate" value="5">
                        </div>
                        <div class="input-group">
                            <label>وقت التسويق (شهر)</label>
                            <input type="number" id="timeToMarket" value="6">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>التغذية والمياه</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>علف كجم/يوم</label>
                            <input type="number" id="feedPerDay" value="1.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>سعر طن العلف</label>
                            <input type="number" id="feedPriceTon" value="12000">
                        </div>
                        <div class="input-group">
                            <label>معدل تحويل</label>
                            <input type="number" id="feedConversion" value="5" step="0.1">
                            <span class="small-text">كجم علف/كجم زيادة</span>
                        </div>
                        <div class="input-group">
                            <label>مياه لتر/يوم</label>
                            <input type="number" id="waterPerDay" value="8">
                            <span class="small-text">يزيد لـ12 في الصيف</span>
                        </div>
                        <div class="input-group">
                            <label>سعر م³ مياه</label>
                            <input type="number" id="waterPrice" value="3.5" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- البنية التحتية -->
        <div id="infrastructure" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h3>الأرض والمباني</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>مساحة (م²)</label>
                            <input type="number" id="landArea" value="2000">
                        </div>
                        <div class="input-group">
                            <label>إيجار سنوي</label>
                            <input type="number" id="landRent" value="60000">
                            <span class="small-text">0 إذا تملك</span>
                        </div>
                        <div class="input-group">
                            <label>بناء الحظائر</label>
                            <input type="number" id="shelterCost" value="150000">
                        </div>
                        <div class="input-group">
                            <label>السياج</label>
                            <input type="number" id="fencingCost" value="40000">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>المعدات والتجهيزات</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>نظام المياه</label>
                            <input type="number" id="waterSystem" value="25000">
                        </div>
                        <div class="input-group">
                            <label>تدوير المياه</label>
                            <input type="number" id="waterRecycling" value="40000">
                            <span class="small-text">يوفر 30%</span>
                        </div>
                        <div class="input-group">
                            <label>معدات التغذية</label>
                            <input type="number" id="feedingEquipment" value="15000">
                        </div>
                        <div class="input-group">
                            <label>مخزن العلف</label>
                            <input type="number" id="feedStorage" value="30000">
                        </div>
                        <div class="input-group">
                            <label>ثلاجات حفظ</label>
                            <input type="number" id="refrigerators" value="80000">
                        </div>
                        <div class="input-group">
                            <label>فريزرات</label>
                            <input type="number" id="freezers" value="60000">
                        </div>
                        <div class="input-group">
                            <label>معدات تغليف</label>
                            <input type="number" id="packagingEquipment" value="35000">
                        </div>
                        <div class="input-group">
                            <label>نظام بيوجاز</label>
                            <input type="number" id="biogasSystem" value="75000">
                            <span class="small-text">اختياري</span>
                        </div>
                        <div class="input-group">
                            <label>معدات أخرى</label>
                            <input type="number" id="otherEquipment" value="20000">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>المركبات والنقل</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>سيارة نقل عادية</label>
                            <input type="number" id="vehicle" value="0">
                            <span class="small-text">0 إذا نقل مؤجر</span>
                        </div>
                        <div class="input-group">
                            <label>سيارة مبردة</label>
                            <input type="number" id="refrigeratedVehicle" value="350000">
                        </div>
                        <div class="input-group">
                            <label>نقل شهري</label>
                            <input type="number" id="transportMonthly" value="5000">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>البيع الأونلاين والتقنية</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>موقع إلكتروني</label>
                            <input type="number" id="website" value="25000">
                        </div>
                        <div class="input-group">
                            <label>تطبيق موبايل</label>
                            <input type="number" id="mobileApp" value="50000">
                        </div>
                        <div class="input-group">
                            <label>بوابة دفع</label>
                            <input type="number" id="paymentGateway" value="10000">
                        </div>
                        <div class="input-group">
                            <label>نظام المخزون</label>
                            <input type="number" id="inventorySystem" value="15000">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- التشغيل -->
        <div id="operations" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h3>العمالة</h3>
                    <div class="input-group">
                        <label>عدد العمال</label>
                        <input type="number" id="workers" value="2">
                    </div>
                    <div class="input-group">
                        <label>راتب العامل الشهري</label>
                        <input type="number" id="workerSalary" value="3000">
                    </div>
                    <div class="input-group">
                        <label>مشرف/مدير (راتب شهري)</label>
                        <input type="number" id="managerSalary" value="0">
                        <span class="small-text">0 إذا كنت ستدير بنفسك</span>
                    </div>
                </div>
                
                <div class="section">
                    <h3>الخدمات البيطرية</h3>
                    <div class="input-group">
                        <label>تكلفة التحصينات السنوية/رأس</label>
                        <input type="number" id="vaccinesPerHead" value="150">
                    </div>
                    <div class="input-group">
                        <label>ميزانية طوارئ بيطرية شهرية</label>
                        <input type="number" id="vetEmergency" value="2500">
                    </div>
                    <div class="input-group">
                        <label>فحص دوري شهري</label>
                        <input type="number" id="vetCheckup" value="1500">
                    </div>
                </div>
                
                <div class="section">
                    <h3>مصاريف أخرى</h3>
                    <div class="input-group">
                        <label>الكهرباء والماء شهرياً</label>
                        <input type="number" id="utilities" value="2000">
                    </div>
                    <div class="input-group">
                        <label>التسويق والإعلان شهرياً</label>
                        <input type="number" id="marketing" value="3000">
                    </div>
                    <div class="input-group">
                        <label>إعلانات فيسبوك وإنستجرام</label>
                        <input type="number" id="digitalMarketing" value="5000">
                    </div>
                    <div class="input-group">
                        <label>التأمين السنوي</label>
                        <input type="number" id="insurance" value="12000">
                    </div>
                    <div class="input-group">
                        <label>رخص وتصاريح سنوية</label>
                        <input type="number" id="licenses" value="8000">
                    </div>
                    <div class="input-group">
                        <label>شهادة الذبح الحلال</label>
                        <input type="number" id="halalCertificate" value="15000">
                    </div>
                    <div class="input-group">
                        <label>شهادات الجودة والصحة</label>
                        <input type="number" id="qualityCertificates" value="10000">
                    </div>
                </div>
                
                <div class="section">
                    <h3>تكاليف الذبح والتجهيز</h3>
                    <div class="input-group">
                        <label>رسوم المجزر/خروف</label>
                        <input type="number" id="slaughterFee" value="100">
                    </div>
                    <div class="input-group">
                        <label>تكلفة التقطيع والتغليف/خروف</label>
                        <input type="number" id="processingFee" value="150">
                    </div>
                    <div class="input-group">
                        <label>أكياس تفريغ وتعبئة شهرياً</label>
                        <input type="number" id="packagingMonthly" value="2000">
                    </div>
                    <div class="input-group">
                        <label>عمالة مؤقتة للكاترينج/مناسبة</label>
                        <input type="number" id="cateringStaffPerEvent" value="1500">
                    </div>
                    <div class="input-group">
                        <label>تكلفة التوصيل شهرياً</label>
                        <input type="number" id="deliveryCost" value="3000">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- برنامج التربية -->
        <div id="breeding" class="tab-content">
            <div class="info-box">
                🐏 حدد برنامج التربية والتناسل لتحسين الإنتاجية
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>معدلات التناسل</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>معدل الخصوبة %</label>
                            <input type="number" id="fertilityRate" value="85">
                        </div>
                        <div class="input-group">
                            <label>ولادات/سنة</label>
                            <input type="number" id="birthsPerYear" value="1.5" step="0.1">
                            <span class="small-text">3 ولادات/سنتين</span>
                        </div>
                        <div class="input-group">
                            <label>مواليد/ولادة</label>
                            <input type="number" id="lambsPerBirth" value="1.3" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>نسبة توائم %</label>
                            <input type="number" id="twinRate" value="30">
                        </div>
                        <div class="input-group">
                            <label>عمر أول ولادة</label>
                            <input type="number" id="firstBirthAge" value="18">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>برنامج التلقيح</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>نوع التلقيح</label>
                            <select id="inseminationType">
                                <option value="natural">طبيعي</option>
                                <option value="artificial">صناعي</option>
                                <option value="mixed">مختلط</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>تكلفة صناعي/نعجة</label>
                            <input type="number" id="artificialInseminationCost" value="200">
                        </div>
                        <div class="input-group">
                            <label>نجاح التلقيح %</label>
                            <input type="number" id="inseminationSuccess" value="75">
                        </div>
                        <div class="input-group">
                            <label>كباش مطلوبة</label>
                            <input type="number" id="ramsNeeded" value="3" readonly>
                            <span class="small-text">كبش/25 نعجة</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>جدول التربية</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>موسم التلقيح</label>
                            <select id="mainBreedingSeason">
                                <option value="spring">الربيع (مارس-مايو)</option>
                                <option value="fall">الخريف (سبتمبر-نوفمبر)</option>
                                <option value="both">موسمين</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>فترة الحمل</label>
                            <input type="number" id="gestationPeriod" value="150" readonly>
                        </div>
                        <div class="input-group">
                            <label>فترة الرضاعة</label>
                            <input type="number" id="lactationPeriod" value="90">
                        </div>
                        <div class="input-group">
                            <label>عمر الفطام</label>
                            <input type="number" id="weaningAge" value="90">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>تحسين السلالة</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>برنامج تحسين</label>
                            <select id="geneticImprovement">
                                <option value="none">لا يوجد</option>
                                <option value="local">محلي</option>
                                <option value="import">استيراد</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>تكلفة كبش محسن</label>
                            <input type="number" id="improvedRamCost" value="25000">
                        </div>
                        <div class="input-group">
                            <label>عدد كباش محسنة</label>
                            <input type="number" id="improvedRamsCount" value="1">
                        </div>
                        <div class="input-group">
                            <label>زيادة إنتاجية %</label>
                            <input type="number" id="productivityIncrease" value="20">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- المخاطر والضرائب -->
        <div id="risks" class="tab-content">
            <div class="info-box">
                ⚠️ تقييم المخاطر والالتزامات المالية للمشروع
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>إدارة المخاطر</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>احتياطي صحي %</label>
                            <input type="number" id="healthEmergency" value="10">
                            <span class="small-text">من قيمة القطيع</span>
                        </div>
                        <div class="input-group">
                            <label>نفوق حرارة %</label>
                            <input type="number" id="heatWaveMortality" value="3">
                        </div>
                        <div class="input-group">
                            <label>تقلب أعلاف %</label>
                            <input type="number" id="feedPriceVolatility" value="15">
                        </div>
                        <div class="input-group">
                            <label>توقف توريد يوم</label>
                            <input type="number" id="supplyInterruption" value="10">
                        </div>
                        <div class="input-group">
                            <label>نظام تبريد</label>
                            <input type="number" id="coolingSystems" value="30000">
                        </div>
                        <div class="input-group">
                            <label>تأمين كوارث</label>
                            <input type="number" id="naturalDisasterInsurance" value="15000">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>الضرائب والرسوم</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>ضريبة دخل %</label>
                            <input type="number" id="incomeTax" value="22.5">
                        </div>
                        <div class="input-group">
                            <label>قيمة مضافة %</label>
                            <input type="number" id="vat" value="14">
                        </div>
                        <div class="input-group">
                            <label>رسوم بلدية</label>
                            <input type="number" id="municipalFees" value="5000">
                        </div>
                        <div class="input-group">
                            <label>غرفة تجارة</label>
                            <input type="number" id="chamberFees" value="2000">
                        </div>
                        <div class="input-group">
                            <label>اتحاد منتجين</label>
                            <input type="number" id="producerUnionFees" value="3000">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>الزكاة</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>نصاب الغنم</label>
                            <input type="number" id="zakatNisab" value="40" readonly>
                        </div>
                        <div class="input-group">
                            <label>زكاة مستحقة</label>
                            <input type="number" id="zakatDue" value="0" readonly>
                            <span class="small-text">تحسب تلقائياً</span>
                        </div>
                        <div class="input-group">
                            <label>قيمة بالجنيه</label>
                            <input type="number" id="zakatValue" value="0" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>التصدير والجودة</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>شهادات تصدير</label>
                            <input type="number" id="exportCertificates" value="25000">
                        </div>
                        <div class="input-group">
                            <label>شحن/خروف</label>
                            <input type="number" id="shippingPerHead" value="500">
                        </div>
                        <div class="input-group">
                            <label>ISO 22000</label>
                            <input type="number" id="isoCertificate" value="50000">
                        </div>
                        <div class="input-group">
                            <label>منصات أونلاين</label>
                            <input type="number" id="onlinePlatformFees" value="24000">
                            <span class="small-text">أمازون، جوميا</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- التحليل الموسمي -->
        <div id="seasonal" class="tab-content">
            <div class="info-box">
                📅 حدد توزيع المبيعات المتوقع على مدار السنة لحساب احتياجات السيولة
            </div>
            
            <div class="grid-3">
                <div class="section-compact">
                    <h3>توزيع الأضاحي</h3>
                    <div class="grid-2" style="gap: 4px;">
                        <div class="compact-input">
                            <label>ذو الحجة %</label>
                            <input type="number" id="eidSales" value="85">
                            <span class="small-text">النسبة الأكبر</span>
                        </div>
                        <div class="compact-input">
                            <label>باقي السنة %</label>
                            <input type="number" id="nonEidSales" value="15" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="section-compact">
                    <h3>المواسم</h3>
                    <div class="compact-grid">
                        <div class="compact-input">
                            <label>رمضان+</label>
                            <input type="number" id="ramadanIncrease" value="30">
                        </div>
                        <div class="compact-input">
                            <label>صيف+</label>
                            <input type="number" id="summerCatering" value="40">
                            <span class="small-text" style="font-size: 0.6rem;">موسم الأفراح</span>
                        </div>
                        <div class="compact-input">
                            <label>شتاء-</label>
                            <input type="number" id="winterDecrease" value="20">
                        </div>
                    </div>
                </div>
                
                <div class="section-compact">
                    <h3>السيولة</h3>
                    <div style="font-size: 0.8rem; line-height: 1.4;">
                        <div style="margin-bottom: 5px;">
                            <strong>أعلى احتياج:</strong> شهر <span id="highestCashNeed">0</span>
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong>أقل إيراد:</strong> <span id="lowestRevenue">0</span>
                        </div>
                        <div style="margin-bottom: 5px;">
                            <strong>أعلى إيراد:</strong> <span id="highestRevenue">0</span>
                        </div>
                        <div style="background: #e8f4f8; padding: 5px; border-radius: 3px; margin-top: 6px;">
                            <strong>احتياطي مطلوب:</strong> <span id="cashReserve" style="color: #2c3e50;">0</span> جنيه
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- التحليل المالي -->
        <div id="financial" class="tab-content">
            <!-- Visual Analytics Charts -->
            <div class="chart-section">
                <h3>📊 الرسوم البيانية التحليلية</h3>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="breakEvenChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="costBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="summary-section">
                <h2>📊 الملخص المالي الشامل</h2>
                
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">الاستثمار المطلوب</div>
                        <div class="metric-value"><span id="totalInvestment">0</span> جنيه</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">إيرادات السنة 1</div>
                        <div class="metric-value"><span id="yearOneRevenue">0</span> جنيه</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">تكاليف السنة 1</div>
                        <div class="metric-value"><span id="yearOneCosts">0</span> جنيه</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">صافي الربح</div>
                        <div class="metric-value"><span id="yearOneProfit">0</span> جنيه</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">نقطة التعادل</div>
                        <div class="metric-value"><span id="breakEven">0</span> شهر</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">العائد ROI</div>
                        <div class="metric-value"><span id="roi">0</span>%</div>
                    </div>
                </div>
                
                <div id="decisionBox" class="decision-box">
                    جاري الحساب...
                </div>
                
                <div style="margin-top: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px;">
                    <h3 style="color: white; margin-bottom: 6px; font-size: 0.9rem;">تفاصيل التحليل:</h3>
                    
                    <div class="grid-3" style="color: white; font-size: 0.75rem; line-height: 1.3; gap: 10px;">
                        <div style="background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                            <strong style="display: block; margin-bottom: 4px; color: #ffd700;">💰 الاستثمار</strong>
                            <div>البنية: <span id="infraTotal">0</span></div>
                            <div>القطيع: <span id="flockTotal">0</span></div>
                            <div>رأس مال: <span id="workingCapital">0</span></div>
                            <div>أونلاين: <span id="onlineTotal">0</span></div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                            <strong style="display: block; margin-bottom: 4px; color: #ffd700;">📊 شهرياً</strong>
                            <div>تشغيل: <span id="monthlyOperating">0</span></div>
                            <div>ذبح: <span id="processingCosts">0</span></div>
                            <div>تسويق: <span id="digitalMarketingCost">0</span></div>
                            <div>مياه: <span id="waterCostDisplay">0</span></div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                            <strong style="display: block; margin-bottom: 4px; color: #ffd700;">💵 إيرادات</strong>
                            <div>أضاحي: <span id="udheyaRevenue">0</span></div>
                            <div>لحوم: <span id="meatRevenue">0</span></div>
                            <div>حية: <span id="liveAnimalRevenue">0</span></div>
                            <div>كاترينج: <span id="cateringRevenue">0</span></div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                            <strong style="display: block; margin-bottom: 4px; color: #ffd700;">➕ إضافية</strong>
                            <div>تأجير: <span id="eventRentalRevenue">0</span></div>
                            <div>تصدير: <span id="exportRevenue">0</span></div>
                            <div>سماد: <span id="manureRevenue">0</span></div>
                            <div>جلود: <span id="hideRevenue">0</span></div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                            <strong style="display: block; margin-bottom: 4px; color: #ffd700;">📈 مؤشرات</strong>
                            <div>هامش: <span id="profitMargin">0</span>%</div>
                            <div>استرداد: <span id="paybackPeriod">0</span>م</div>
                            <div>سيولة: <span id="requiredCashReserve">0</span></div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                            <strong style="display: block; margin-bottom: 4px; color: #ffd700;">⚖️ التزامات</strong>
                            <div>زكاة: <span id="zakatDisplay">0</span></div>
                            <div>ضريبة: <span id="taxDisplay">0</span></div>
                            <div>مخاطر: <span id="riskReserveDisplay">0</span></div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Multi-Year Planning -->
        <div id="multiyear" class="tab-content">
            <div class="info-box">
                📈 التخطيط الاستراتيجي للمشروع على مدار 5 سنوات مع نمو القطيع والاستثمارات
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>معدلات النمو المتوقعة</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>نمو القطيع السنوي %</label>
                            <input type="number" id="flockGrowthRate" value="25">
                            <span class="small-text">من خلال المواليد والشراء</span>
                        </div>
                        <div class="input-group">
                            <label>تحسن الإنتاجية %</label>
                            <input type="number" id="productivityImprovement" value="5">
                            <span class="small-text">سنوياً</span>
                        </div>
                        <div class="input-group">
                            <label>زيادة الأسعار %</label>
                            <input type="number" id="priceInflation" value="8">
                        </div>
                        <div class="input-group">
                            <label>زيادة التكاليف %</label>
                            <input type="number" id="costInflation" value="6">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>خطة التوسعات</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>توسعة السنة 2</label>
                            <input type="number" id="expansion2" value="100000">
                            <span class="small-text">حظائر إضافية</span>
                        </div>
                        <div class="input-group">
                            <label>توسعة السنة 3</label>
                            <input type="number" id="expansion3" value="150000">
                            <span class="small-text">معدات تصنيع</span>
                        </div>
                        <div class="input-group">
                            <label>توسعة السنة 5</label>
                            <input type="number" id="expansion5" value="200000">
                            <span class="small-text">فرع جديد</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5-Year Projections Table -->
            <div class="chart-section">
                <h3>📊 الإسقاطات المالية لـ 5 سنوات</h3>
                <table id="fiveYearTable" style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <thead style="background: #3498db; color: white;">
                        <tr>
                            <th style="padding: 8px; border: 1px solid #ddd;">البيان</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">السنة 1</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">السنة 2</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">السنة 3</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">السنة 4</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">السنة 5</th>
                        </tr>
                    </thead>
                    <tbody id="fiveYearTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Multi-Year Charts -->
            <div class="chart-section">
                <h3>📈 الرسوم البيانية متعددة السنوات</h3>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="multiYearRevenueChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="flockGrowthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feed Optimizer -->
        <div id="feedOptimizer" class="tab-content">
            <div class="info-box">
                🌾 محسن الأعلاف - احسب التركيبة المثلى للعلف لتحقيق أفضل نسبة تكلفة/تغذية
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>مكونات العلف المتاحة</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>ذرة - سعر/طن</label>
                            <input type="number" id="cornPrice" value="8000">
                            <span class="small-text">طاقة: 3.2 ميجا كالوري</span>
                        </div>
                        <div class="input-group">
                            <label>كسب فول صويا - سعر/طن</label>
                            <input type="number" id="soybeanPrice" value="15000">
                            <span class="small-text">بروتين: 44%</span>
                        </div>
                        <div class="input-group">
                            <label>نخالة قمح - سعر/طن</label>
                            <input type="number" id="wheatBranPrice" value="6000">
                            <span class="small-text">ألياف: 12%</span>
                        </div>
                        <div class="input-group">
                            <label>شعير - سعر/طن</label>
                            <input type="number" id="barleyPrice" value="7000">
                            <span class="small-text">طاقة: 2.8 ميجا كالوري</span>
                        </div>
                        <div class="input-group">
                            <label>علف مركز - سعر/طن</label>
                            <input type="number" id="concentratePrice" value="12000">
                            <span class="small-text">متوازن</span>
                        </div>
                        <div class="input-group">
                            <label>دريس برسيم - سعر/طن</label>
                            <input type="number" id="alfalfaPrice" value="4000">
                            <span class="small-text">ألياف عالية</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>المتطلبات الغذائية</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>البروتين المطلوب %</label>
                            <input type="number" id="requiredProtein" value="16" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>الطاقة المطلوبة (ميجا كالوري/كجم)</label>
                            <input type="number" id="requiredEnergy" value="2.8" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>الألياف القصوى %</label>
                            <input type="number" id="maxFiber" value="18">
                        </div>
                        <div class="input-group">
                            <label>كمية العلف اليومية (كجم)</label>
                            <input type="number" id="dailyFeedAmount" value="1.5" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Optimized Feed Formula -->
            <div class="chart-section">
                <h3>🎯 التركيبة المثلى للعلف</h3>
                <div class="grid-2">
                    <div>
                        <h4>النسب المثلى:</h4>
                        <div id="optimalFormula" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="result">
                            تكلفة الطن: <span id="optimalCost">0</span> جنيه
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="feedCompositionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Breeding Calendar -->
        <div id="breedingCalendar" class="tab-content">
            <div class="info-box">
                📅 تقويم التربية وتتبع مواعيد التلقيح والولادة والفطام
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>برنامج التلقيح السنوي</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>بداية موسم التلقيح الأول</label>
                            <input type="date" id="breeding1Start" value="2024-09-01">
                        </div>
                        <div class="input-group">
                            <label>بداية موسم التلقيح الثاني</label>
                            <input type="date" id="breeding2Start" value="2025-03-01">
                        </div>
                        <div class="input-group">
                            <label>مدة التلقيح (يوم)</label>
                            <input type="number" id="breedingDuration" value="45">
                        </div>
                        <div class="input-group">
                            <label>فترة الحمل (يوم)</label>
                            <input type="number" id="gestationDays" value="150" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Breeding Calendar Display -->
            <div class="chart-section">
                <h3>📅 تقويم الأحداث المهمة</h3>
                <div id="breedingSchedule" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Production Timeline Chart -->
            <div class="chart-section">
                <h3>📈 خط زمني للإنتاج</h3>
                <div class="chart-container">
                    <canvas id="productionTimelineChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Sensitivity Analysis -->
        <div id="sensitivity" class="tab-content">
            <div class="info-box">
                🔍 تحليل الحساسية - اعرف كيف تؤثر التغييرات في المتغيرات الرئيسية على ربحية المشروع
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>نطاق التحليل</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>تغيير أسعار البيع (%)</label>
                            <input type="number" id="priceVariation" value="20" step="5">
                        </div>
                        <div class="input-group">
                            <label>تغيير تكاليف العلف (%)</label>
                            <input type="number" id="feedCostVariation" value="25" step="5">
                        </div>
                        <div class="input-group">
                            <label>تغيير معدل الولادة (%)</label>
                            <input type="number" id="birthRateVariation" value="15" step="5">
                        </div>
                        <div class="input-group">
                            <label>تغيير معدل النفوق (%)</label>
                            <input type="number" id="mortalityVariation" value="10" step="2">
                        </div>
                        <div class="input-group">
                            <label>تغيير الطلب على المنتج (%)</label>
                            <input type="number" id="demandVariation" value="30" step="5">
                        </div>
                        <div class="input-group">
                            <label>عدد محاكاة مونت كارلو</label>
                            <input type="number" id="monteCarloRuns" value="1000" step="100">
                        </div>
                    </div>
                    <button onclick="runSensitivityAnalysis()" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        تشغيل التحليل
                    </button>
                </div>
            </div>
            
            <!-- Sensitivity Results -->
            <div class="chart-section">
                <h3>📈 نتائج تحليل الحساسية</h3>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="monteCarloChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Risk Assessment -->
            <div class="chart-section">
                <h3>⚠️ تقييم المخاطر</h3>
                <div id="riskAssessment" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Market Intelligence -->
        <div id="marketIntel" class="tab-content">
            <div class="info-box">
                📈 ذكاء السوق - تحليل اتجاهات الأسعار والمنافسين وتوقع الطلب
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>بيانات الأسعار التاريخية</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>متوسط سعر الأضحية 2023</label>
                            <input type="number" id="price2023" value="7500">
                        </div>
                        <div class="input-group">
                            <label>متوسط سعر الأضحية 2022</label>
                            <input type="number" id="price2022" value="7000">
                        </div>
                        <div class="input-group">
                            <label>متوسط سعر الأضحية 2021</label>
                            <input type="number" id="price2021" value="6500">
                        </div>
                        <div class="input-group">
                            <label>زيادة رمضان %</label>
                            <input type="number" id="ramadanPriceIncrease" value="15">
                        </div>
                        <div class="input-group">
                            <label>زيادة الحج %</label>
                            <input type="number" id="hajjPriceIncrease" value="25">
                        </div>
                        <div class="input-group">
                            <label>انخفاض الصيف %</label>
                            <input type="number" id="summerPriceDecrease" value="10">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>تحليل المنافسين</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>عدد المزارع في المنطقة</label>
                            <input type="number" id="competitorCount" value="8">
                        </div>
                        <div class="input-group">
                            <label>متوسط حجم قطيع المنافس</label>
                            <input type="number" id="competitorFlockSize" value="40">
                        </div>
                        <div class="input-group">
                            <label>حصتنا المتوقعة من السوق %</label>
                            <input type="number" id="marketShare" value="12">
                        </div>
                        <div class="input-group">
                            <label>ميزتنا التنافسية</label>
                            <select id="competitiveAdvantage">
                                <option value="price">السعر</option>
                                <option value="quality">الجودة</option>
                                <option value="service">الخدمة</option>
                                <option value="location">الموقع</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>توقع الطلب</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>عدد العائلات في المنطقة</label>
                            <input type="number" id="totalFamilies" value="5000">
                        </div>
                        <div class="input-group">
                            <label>نسبة من يضحي %</label>
                            <input type="number" id="sacrificePercentage" value="70">
                        </div>
                        <div class="input-group">
                            <label>نمو عدد السكان سنوياً %</label>
                            <input type="number" id="populationGrowth" value="2.5">
                        </div>
                        <div class="input-group">
                            <label>زيادة القوة الشرائية %</label>
                            <input type="number" id="purchasingPowerGrowth" value="5">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Price Trends Chart -->
            <div class="chart-section">
                <h3>📈 اتجاهات الأسعار وتوقعات الطلب</h3>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="priceTrendsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="demandForecastChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Compliance & Certification -->
        <div id="compliance" class="tab-content">
            <div class="info-box">
                📋 متتبع الالتزامات - تأكد من استيفاء جميع المتطلبات القانونية والشهادات
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>الوثائق الأساسية</h3>
                    <div id="basicDocuments" class="compact-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="section">
                    <h3>شهادات الجودة والصحة</h3>
                    <div id="qualityDocuments" class="compact-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="section">
                    <h3>متطلبات التصدير</h3>
                    <div id="exportDocuments" class="compact-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Compliance Progress -->
            <div class="chart-section">
                <h3>📈 حالة الالتزام</h3>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="complianceChart"></canvas>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>ملخص الالتزام:</h4>
                        <div id="complianceSummary">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Operational Tools -->
        <div id="operations" class="tab-content">
            <div class="info-box">
                🛠️ أدوات تشغيلية - محاكي الأمراض، جدولة العمالة، محول العملات
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>محاكي تفشي الأمراض</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>نوع المرض</label>
                            <select id="diseaseType">
                                <option value="ppr">طاعون المجترات الصغيرة</option>
                                <option value="fmd">الحمى القلاعية</option>
                                <option value="parasites">الطفيليات</option>
                                <option value="respiratory">أمراض تنفسية</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>نسبة الإصابة المتوقعة %</label>
                            <input type="number" id="infectionRate" value="30">
                        </div>
                        <div class="input-group">
                            <label>نسبة النفوق %</label>
                            <input type="number" id="diseaseMortality" value="15">
                        </div>
                        <div class="input-group">
                            <label>فترة العلاج (يوم)</label>
                            <input type="number" id="treatmentDuration" value="14">
                        </div>
                        <div class="input-group">
                            <label>تكلفة العلاج/رأس</label>
                            <input type="number" id="treatmentCost" value="500">
                        </div>
                        <div class="input-group">
                            <label>فقدان الوزن %</label>
                            <input type="number" id="weightLoss" value="20">
                        </div>
                    </div>
                    <button onclick="simulateOutbreak()" style="padding: 8px 20px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        محاكاة التفشي
                    </button>
                </div>
                
                <div class="section">
                    <h3>جدولة العمالة</h3>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>عدد ساعات العمل اليومية</label>
                            <input type="number" id="dailyWorkHours" value="8">
                        </div>
                        <div class="input-group">
                            <label>عدد أيام العمل الأسبوعية</label>
                            <input type="number" id="workDaysPerWeek" value="6">
                        </div>
                        <div class="input-group">
                            <label>معدل العمل الإضافي %</label>
                            <input type="number" id="overtimeRate" value="50">
                        </div>
                        <div class="input-group">
                            <label>عدد أيام الإجازة السنوية</label>
                            <input type="number" id="annualLeaveDays" value="21">
                        </div>
                    </div>
                    <button onclick="optimizeSchedule()" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        تحسين الجدولة
                    </button>
                </div>
                
                <div class="section">
                    <h3>محول العملات</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>سعر الدولار الأمريكي</label>
                            <input type="number" id="usdRate" value="31" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>سعر اليورو</label>
                            <input type="number" id="eurRate" value="33" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>سعر الريال السعودي</label>
                            <input type="number" id="sarRate" value="8.25" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>المبلغ بالجنيه</label>
                            <input type="number" id="egpAmount" value="1000">
                        </div>
                        <div class="input-group">
                            <label>بالدولار</label>
                            <input type="number" id="usdAmount" readonly>
                        </div>
                        <div class="input-group">
                            <label>باليورو</label>
                            <input type="number" id="eurAmount" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Disease Impact Results -->
            <div class="chart-section">
                <h3>📈 نتائج المحاكاة والتحسين</h3>
                <div class="grid-2">
                    <div id="outbreakResults" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>تأثير تفشي المرض:</h4>
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div id="scheduleResults" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>تحسين جدولة العمل:</h4>
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideModal('reportModal')">&times;</span>
            <h3>📈 تقرير الجدوى المفصل</h3>
            <div id="detailedReport"></div>
            <button onclick="printReport()">طباعة التقرير</button>
        </div>
    </div>
    
    <script>
        // Show tab function
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Recalculate when showing financial, seasonal, breeding or risks tab
            if (tabName === 'financial' || tabName === 'seasonal' || tabName === 'breeding' || tabName === 'risks') {
                calculateAll();
                if (tabName === 'financial') {
                    setTimeout(createCharts, 100); // Delay to ensure DOM is ready
                }
            }
            
            // Handle multi-year planning tab
            if (tabName === 'multiyear') {
                calculateAll();
                setTimeout(calculateMultiYear, 100);
            }
            
            // Handle feed optimizer tab
            if (tabName === 'feedOptimizer') {
                setTimeout(optimizeFeed, 100);
            }
            
            // Handle breeding calendar tab
            if (tabName === 'breedingCalendar') {
                setTimeout(generateBreedingCalendar, 100);
            }
            
            // Handle sensitivity analysis tab
            if (tabName === 'sensitivity') {
                // Sensitivity analysis runs on demand
            }
            
            // Handle market intelligence tab
            if (tabName === 'marketIntel') {
                setTimeout(() => {
                    createPriceTrendsChart();
                    createDemandForecastChart();
                }, 100);
            }
            
            // Handle compliance tab
            if (tabName === 'compliance') {
                setTimeout(initializeCompliance, 100);
            }
            
            // Handle operations tab
            if (tabName === 'operations') {
                setTimeout(updateCurrencyConverter, 100);
            }
        }
        
        // Get all inputs
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && (activeTab.id === 'financial' || activeTab.id === 'seasonal' || 
                                 activeTab.id === 'breeding' || activeTab.id === 'risks')) {
                    calculateAll();
                }
            });
        });
        
        function calculateAll() {
            // Market data
            const udheyaPrice = parseFloat(document.getElementById('udheyaPrice').value) || 0;
            const meatPrice = parseFloat(document.getElementById('meatPrice').value) || 0;
            const liveAnimalPrice = parseFloat(document.getElementById('liveAnimalPrice').value) || 0;
            const cateringPrice = parseFloat(document.getElementById('cateringPrice').value) || 0;
            const eventRentalPrice = parseFloat(document.getElementById('eventRentalPrice').value) || 0;
            const manurePrice = parseFloat(document.getElementById('manurePrice').value) || 0;
            const hidePrice = parseFloat(document.getElementById('hidePrice').value) || 0;
            const exportPrice = parseFloat(document.getElementById('exportPrice').value) || 0;
            const udheyaCustomers = parseFloat(document.getElementById('udheyaCustomers').value) || 0;
            const meatDemand = parseFloat(document.getElementById('meatDemand').value) || 0;
            const liveAnimalMonthly = parseFloat(document.getElementById('liveAnimalMonthly').value) || 0;
            const cateringEvents = parseFloat(document.getElementById('cateringEvents').value) || 0;
            const cateringPeople = parseFloat(document.getElementById('cateringPeople').value) || 0;
            const eventRentals = parseFloat(document.getElementById('eventRentals').value) || 0;
            const exportMonthly = parseFloat(document.getElementById('exportMonthly').value) || 0;
            const manureProduction = parseFloat(document.getElementById('manureProduction').value) || 0;
            
            // Payment terms
            const cashCustomers = parseFloat(document.getElementById('cashCustomers').value) || 0;
            const collectionPeriod = parseFloat(document.getElementById('collectionPeriod').value) || 0;
            
            // Catering equipment
            const cateringCooking = parseFloat(document.getElementById('cateringCooking').value) || 0;
            const cateringFurniture = parseFloat(document.getElementById('cateringFurniture').value) || 0;
            const cateringServing = parseFloat(document.getElementById('cateringServing').value) || 0;
            const generator = parseFloat(document.getElementById('generator').value) || 0;
            const photography = parseFloat(document.getElementById('photography').value) || 0;
            
            // Livestock data
            const initialSheep = parseFloat(document.getElementById('initialSheep').value) || 0;
            const sheepCost = parseFloat(document.getElementById('sheepCost').value) || 0;
            const ewes = parseFloat(document.getElementById('ewes').value) || 0;
            const birthRate = parseFloat(document.getElementById('birthRate').value) || 0;
            const mortalityRate = parseFloat(document.getElementById('mortalityRate').value) || 0;
            const feedPerDay = parseFloat(document.getElementById('feedPerDay').value) || 0;
            const feedPriceTon = parseFloat(document.getElementById('feedPriceTon').value) || 0;
            const waterPerDay = parseFloat(document.getElementById('waterPerDay').value) || 0;
            const waterPrice = parseFloat(document.getElementById('waterPrice').value) || 0;
            
            // Breeding program
            const fertilityRate = parseFloat(document.getElementById('fertilityRate').value) || 0;
            const birthsPerYear = parseFloat(document.getElementById('birthsPerYear').value) || 0;
            const lambsPerBirth = parseFloat(document.getElementById('lambsPerBirth').value) || 0;
            const artificialInseminationCost = parseFloat(document.getElementById('artificialInseminationCost').value) || 0;
            const improvedRamCost = parseFloat(document.getElementById('improvedRamCost').value) || 0;
            const improvedRamsCount = parseFloat(document.getElementById('improvedRamsCount').value) || 0;
            
            // Infrastructure
            const landRent = parseFloat(document.getElementById('landRent').value) || 0;
            const shelterCost = parseFloat(document.getElementById('shelterCost').value) || 0;
            const fencingCost = parseFloat(document.getElementById('fencingCost').value) || 0;
            const waterSystem = parseFloat(document.getElementById('waterSystem').value) || 0;
            const waterRecycling = parseFloat(document.getElementById('waterRecycling').value) || 0;
            const feedingEquipment = parseFloat(document.getElementById('feedingEquipment').value) || 0;
            const feedStorage = parseFloat(document.getElementById('feedStorage').value) || 0;
            const refrigerators = parseFloat(document.getElementById('refrigerators').value) || 0;
            const freezers = parseFloat(document.getElementById('freezers').value) || 0;
            const packagingEquipment = parseFloat(document.getElementById('packagingEquipment').value) || 0;
            const biogasSystem = parseFloat(document.getElementById('biogasSystem').value) || 0;
            const otherEquipment = parseFloat(document.getElementById('otherEquipment').value) || 0;
            const vehicle = parseFloat(document.getElementById('vehicle').value) || 0;
            const refrigeratedVehicle = parseFloat(document.getElementById('refrigeratedVehicle').value) || 0;
            const transportMonthly = parseFloat(document.getElementById('transportMonthly').value) || 0;
            
            // Risk management
            const coolingSystems = parseFloat(document.getElementById('coolingSystems').value) || 0;
            const naturalDisasterInsurance = parseFloat(document.getElementById('naturalDisasterInsurance').value) || 0;
            const healthEmergency = parseFloat(document.getElementById('healthEmergency').value) || 0;
            const heatWaveMortality = parseFloat(document.getElementById('heatWaveMortality').value) || 0;
            const feedPriceVolatility = parseFloat(document.getElementById('feedPriceVolatility').value) || 0;
            
            // Taxes and fees
            const incomeTax = parseFloat(document.getElementById('incomeTax').value) || 0;
            const vat = parseFloat(document.getElementById('vat').value) || 0;
            const municipalFees = parseFloat(document.getElementById('municipalFees').value) || 0;
            const chamberFees = parseFloat(document.getElementById('chamberFees').value) || 0;
            const producerUnionFees = parseFloat(document.getElementById('producerUnionFees').value) || 0;
            
            // Export and quality
            const exportCertificates = parseFloat(document.getElementById('exportCertificates').value) || 0;
            const shippingPerHead = parseFloat(document.getElementById('shippingPerHead').value) || 0;
            const isoCertificate = parseFloat(document.getElementById('isoCertificate').value) || 0;
            const onlinePlatformFees = parseFloat(document.getElementById('onlinePlatformFees').value) || 0;
            
            // Online setup
            const website = parseFloat(document.getElementById('website').value) || 0;
            const mobileApp = parseFloat(document.getElementById('mobileApp').value) || 0;
            const paymentGateway = parseFloat(document.getElementById('paymentGateway').value) || 0;
            const inventorySystem = parseFloat(document.getElementById('inventorySystem').value) || 0;
            
            // Operations
            const workers = parseFloat(document.getElementById('workers').value) || 0;
            const workerSalary = parseFloat(document.getElementById('workerSalary').value) || 0;
            const managerSalary = parseFloat(document.getElementById('managerSalary').value) || 0;
            const vaccinesPerHead = parseFloat(document.getElementById('vaccinesPerHead').value) || 0;
            const vetEmergency = parseFloat(document.getElementById('vetEmergency').value) || 0;
            const vetCheckup = parseFloat(document.getElementById('vetCheckup').value) || 0;
            const utilities = parseFloat(document.getElementById('utilities').value) || 0;
            const marketing = parseFloat(document.getElementById('marketing').value) || 0;
            const digitalMarketing = parseFloat(document.getElementById('digitalMarketing').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const licenses = parseFloat(document.getElementById('licenses').value) || 0;
            const halalCertificate = parseFloat(document.getElementById('halalCertificate').value) || 0;
            const qualityCertificates = parseFloat(document.getElementById('qualityCertificates').value) || 0;
            
            // Processing costs
            const slaughterFee = parseFloat(document.getElementById('slaughterFee').value) || 0;
            const processingFee = parseFloat(document.getElementById('processingFee').value) || 0;
            const packagingMonthly = parseFloat(document.getElementById('packagingMonthly').value) || 0;
            const cateringStaffPerEvent = parseFloat(document.getElementById('cateringStaffPerEvent').value) || 0;
            const deliveryCost = parseFloat(document.getElementById('deliveryCost').value) || 0;
            
            // Calculations
            // Update rams needed
            document.getElementById('ramsNeeded').value = Math.ceil(ewes / 25);
            
            // Update credit customers
            document.getElementById('creditCustomers').value = 100 - cashCustomers;
            
            // Total catering equipment
            const cateringEquipmentTotal = cateringCooking + cateringFurniture + cateringServing + generator + photography;
            
            // Infrastructure total
            const infrastructureTotal = shelterCost + fencingCost + waterSystem + waterRecycling +
                                      feedingEquipment + feedStorage + refrigerators + freezers +
                                      packagingEquipment + biogasSystem + otherEquipment + vehicle + 
                                      refrigeratedVehicle + cateringEquipmentTotal + coolingSystems;
            
            // Online setup total
            const onlineSetupTotal = website + mobileApp + paymentGateway + inventorySystem;
            
            // Breeding investment
            const breedingInvestment = improvedRamCost * improvedRamsCount;
            
            // Export setup costs
            const exportSetupCosts = exportCertificates + isoCertificate;
            
            // Flock cost
            const flockCost = initialSheep * sheepCost + breedingInvestment;
            
            // Monthly operating costs
            const laborCost = (workers * workerSalary) + managerSalary;
            const feedCostMonthly = (initialSheep * feedPerDay * 30 * feedPriceTon) / 1000;
            const waterCostMonthly = (initialSheep * waterPerDay * 30 * waterPrice) / 1000;
            const vetCostMonthly = vetEmergency + vetCheckup;
            const processingCostMonthly = (slaughterFee + processingFee) * (udheyaCustomers/12 + liveAnimalMonthly + exportMonthly);
            const cateringStaffMonthly = cateringStaffPerEvent * cateringEvents;
            const exportShippingMonthly = shippingPerHead * exportMonthly;
            const breedingCostMonthly = (artificialInseminationCost * ewes * birthsPerYear) / 12;
            const monthlyOperating = laborCost + feedCostMonthly + waterCostMonthly + vetCostMonthly + 
                                   utilities + marketing + digitalMarketing + transportMonthly +
                                   packagingMonthly + processingCostMonthly + cateringStaffMonthly + 
                                   deliveryCost + exportShippingMonthly + breedingCostMonthly;
            
            // Annual operating costs
            const annualFees = municipalFees + chamberFees + producerUnionFees + onlinePlatformFees;
            const annualOperating = (monthlyOperating * 12) + (vaccinesPerHead * initialSheep) + 
                                  insurance + licenses + landRent + halalCertificate + qualityCertificates +
                                  naturalDisasterInsurance + annualFees;
            
            // Risk reserve
            const healthReserve = flockCost * (healthEmergency / 100);
            const feedPriceReserve = feedCostMonthly * 12 * (feedPriceVolatility / 100);
            const totalRiskReserve = healthReserve + feedPriceReserve;
            
            // Working capital (4 months considering payment terms)
            const workingCapitalMonths = 4 + (collectionPeriod / 30);
            const workingCapital = monthlyOperating * workingCapitalMonths + totalRiskReserve;
            
            // Total investment
            const totalInvestment = infrastructureTotal + flockCost + workingCapital + onlineSetupTotal + exportSetupCosts;
            
            // Revenue calculations with improved breeding
            const effectiveFertility = fertilityRate / 100;
            const expectedLambs = ewes * effectiveFertility * birthsPerYear * lambsPerBirth;
            const effectiveMortality = (mortalityRate + heatWaveMortality) / 100;
            const survivalRate = 1 - effectiveMortality;
            const sellableSheep = expectedLambs * survivalRate;
            
            const udheyaRevenue = Math.min(udheyaCustomers, sellableSheep * 0.4) * udheyaPrice;
            const meatRevenue = meatDemand * 12 * meatPrice;
            const liveAnimalRevenue = liveAnimalMonthly * 12 * liveAnimalPrice;
            const cateringRevenue = cateringEvents * 12 * cateringPeople * cateringPrice;
            const eventRentalRevenue = eventRentals * 12 * eventRentalPrice;
            const exportRevenue = exportMonthly * 12 * exportPrice;
            const manureRevenue = manureProduction * manurePrice;
            const hideRevenue = (sellableSheep * 0.8) * hidePrice;
            
            const totalRevenue = udheyaRevenue + meatRevenue + liveAnimalRevenue + cateringRevenue + 
                               eventRentalRevenue + exportRevenue + manureRevenue + hideRevenue;
            
            // Calculate Zakat
            const zakatDue = initialSheep >= 40 ? Math.floor(initialSheep / 40) : 0;
            const zakatValue = zakatDue * sheepCost;
            document.getElementById('zakatDue').value = zakatDue;
            document.getElementById('zakatValue').value = zakatValue;
            
            // First year calculations
            const firstYearCosts = totalInvestment + annualOperating + zakatValue;
            const firstYearProfitBeforeTax = totalRevenue - firstYearCosts;
            const taxAmount = firstYearProfitBeforeTax > 0 ? firstYearProfitBeforeTax * (incomeTax / 100) : 0;
            const firstYearProfit = firstYearProfitBeforeTax - taxAmount;
            
            // Break-even
            let breakEvenMonths = 0;
            if (totalRevenue > annualOperating) {
                const monthlyProfit = (totalRevenue - annualOperating) / 12;
                breakEvenMonths = Math.ceil(totalInvestment / monthlyProfit);
            } else {
                breakEvenMonths = 999;
            }
            
            // ROI and margins
            const roi = totalInvestment > 0 ? ((firstYearProfit / totalInvestment) * 100).toFixed(1) : 0;
            const profitMargin = totalRevenue > 0 ? ((firstYearProfit / totalRevenue) * 100).toFixed(1) : 0;
            
            // Seasonal analysis
            const eidSalesPercent = parseFloat(document.getElementById('eidSales').value) || 85;
            const monthlyAvgRevenue = totalRevenue / 12;
            const eidMonthRevenue = (udheyaRevenue * eidSalesPercent / 100) + (monthlyAvgRevenue * 0.5);
            const lowestMonthRevenue = monthlyAvgRevenue * 0.6;
            const cashReserveNeeded = monthlyOperating * 6 + totalRiskReserve;
            
            // Update displays
            document.getElementById('totalInvestment').textContent = totalInvestment.toLocaleString();
            document.getElementById('yearOneRevenue').textContent = totalRevenue.toLocaleString();
            document.getElementById('yearOneCosts').textContent = firstYearCosts.toLocaleString();
            document.getElementById('yearOneProfit').textContent = firstYearProfit.toLocaleString();
            document.getElementById('breakEven').textContent = breakEvenMonths === 999 ? 'لن يتعادل' : breakEvenMonths;
            document.getElementById('roi').textContent = roi;
            document.getElementById('infraTotal').textContent = infrastructureTotal.toLocaleString();
            document.getElementById('flockTotal').textContent = flockCost.toLocaleString();
            document.getElementById('workingCapital').textContent = workingCapital.toLocaleString();
            document.getElementById('monthlyOperating').textContent = monthlyOperating.toLocaleString();
            document.getElementById('onlineTotal').textContent = onlineSetupTotal.toLocaleString();
            document.getElementById('processingCosts').textContent = processingCostMonthly.toLocaleString();
            document.getElementById('digitalMarketingCost').textContent = digitalMarketing.toLocaleString();
            document.getElementById('udheyaRevenue').textContent = udheyaRevenue.toLocaleString();
            document.getElementById('meatRevenue').textContent = meatRevenue.toLocaleString();
            document.getElementById('liveAnimalRevenue').textContent = liveAnimalRevenue.toLocaleString();
            document.getElementById('cateringRevenue').textContent = cateringRevenue.toLocaleString();
            document.getElementById('eventRentalRevenue').textContent = eventRentalRevenue.toLocaleString();
            document.getElementById('profitMargin').textContent = profitMargin;
            document.getElementById('paybackPeriod').textContent = breakEvenMonths === 999 ? 'غير محدد' : breakEvenMonths;
            document.getElementById('requiredCashReserve').textContent = cashReserveNeeded.toLocaleString();
            
            // Seasonal displays
            document.getElementById('nonEidSales').value = 100 - eidSalesPercent;
            document.getElementById('highestCashNeed').textContent = 'ذو القعدة';
            document.getElementById('lowestRevenue').textContent = lowestMonthRevenue.toLocaleString();
            document.getElementById('highestRevenue').textContent = eidMonthRevenue.toLocaleString();
            document.getElementById('cashReserve').textContent = cashReserveNeeded.toLocaleString();
            
            // Update additional revenue displays
            document.getElementById('exportRevenue').textContent = exportRevenue.toLocaleString();
            document.getElementById('manureRevenue').textContent = manureRevenue.toLocaleString();
            document.getElementById('hideRevenue').textContent = hideRevenue.toLocaleString();
            document.getElementById('zakatDisplay').textContent = zakatValue.toLocaleString();
            document.getElementById('taxDisplay').textContent = taxAmount.toLocaleString();
            document.getElementById('riskReserveDisplay').textContent = totalRiskReserve.toLocaleString();
            document.getElementById('waterCostDisplay').textContent = waterCostMonthly.toLocaleString();
            
            // Decision
            const decisionBox = document.getElementById('decisionBox');
            if (firstYearProfit > 0 && breakEvenMonths <= 12) {
                decisionBox.textContent = '✅ ممتاز - المشروع مربح من السنة الأولى!';
                decisionBox.className = 'decision-box go';
            } else if (firstYearProfit > 0 || (breakEvenMonths <= 18 && totalRevenue > annualOperating)) {
                decisionBox.textContent = '⚠️ جيد - يحتاج مراجعة بعض التفاصيل';
                decisionBox.className = 'decision-box maybe';
            } else {
                decisionBox.textContent = '❌ غير مجدي - المشروع يحتاج إعادة دراسة';
                decisionBox.className = 'decision-box no-go';
            }
            
            // Update quick summary
            const quickSummary = document.getElementById('quickSummary');
            if (quickSummary) {
                quickSummary.style.display = 'block';
                document.getElementById('quickProfit').textContent = firstYearProfit > 0 ? 
                    '+' + (firstYearProfit / 1000).toFixed(0) + 'k' : 
                    (firstYearProfit / 1000).toFixed(0) + 'k';
                document.getElementById('quickInvestment').textContent = (totalInvestment / 1000).toFixed(0) + 'k';
                document.getElementById('quickROI').textContent = roi + '%';
                document.getElementById('quickBreakeven').textContent = breakEvenMonths === 999 ? '∞' : breakEvenMonths;
                document.getElementById('quickRevenue').textContent = (totalRevenue / 1000).toFixed(0) + 'k';
                document.getElementById('quickMargin').textContent = profitMargin + '%';
            }
        }
        
        // Charts storage
        let charts = {};
        
        // Data Management Functions
        function saveProject() {
            const projectData = {
                timestamp: new Date().toISOString(),
                projectName: prompt('اسم المشروع:', 'مشروع تربية الأغنام') || 'مشروع تربية الأغنام',
                data: {}
            };
            
            // Collect all input values
            const inputs = document.querySelectorAll('input[type="number"], select');
            inputs.forEach(input => {
                projectData.data[input.id] = input.value;
            });
            
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectData.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('تم حفظ المشروع بنجاح!');
        }
        
        function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    // Load all values
                    Object.entries(projectData.data).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value;
                        }
                    });
                    
                    calculateAll();
                    alert(`تم تحميل المشروع: ${projectData.projectName}`);
                } catch (error) {
                    alert('خطأ في تحميل الملف');
                }
            };
            reader.readAsText(file);
        }
        
        function exportToPDF() {
            if (typeof jsPDF === 'undefined') {
                alert('مكتبة PDF غير متوفرة');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add Arabic font support (basic)
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(16);
            doc.text('Sheep Farming Feasibility Report', 20, 20);
            
            // Add key metrics
            doc.setFontSize(12);
            let y = 40;
            const metrics = [
                ['Total Investment', document.getElementById('totalInvestment').textContent],
                ['Year 1 Revenue', document.getElementById('yearOneRevenue').textContent],
                ['Year 1 Profit', document.getElementById('yearOneProfit').textContent],
                ['Break Even', document.getElementById('breakEven').textContent + ' months'],
                ['ROI', document.getElementById('roi').textContent + '%']
            ];
            
            metrics.forEach(([label, value]) => {
                doc.text(`${label}: ${value}`, 20, y);
                y += 10;
            });
            
            doc.save('sheep_farming_report.pdf');
        }
        
        function exportToExcel() {
            // Simple CSV export (Excel compatible)
            const data = [
                ['البيان', 'القيمة'],
                ['إجمالي الاستثمار', document.getElementById('totalInvestment').textContent],
                ['إيرادات السنة 1', document.getElementById('yearOneRevenue').textContent],
                ['صافي الربح', document.getElementById('yearOneProfit').textContent],
                ['نقطة التعادل', document.getElementById('breakEven').textContent],
                ['العائد', document.getElementById('roi').textContent + '%']
            ];
            
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sheep_farming_analysis.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'reportModal') {
                generateDetailedReport();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function generateDetailedReport() {
            const report = `
                <div style="text-align: right; direction: rtl; line-height: 1.6;">
                    <h4>📊 ملخص المشروع</h4>
                    <p><strong>إجمالي الاستثمار:</strong> ${document.getElementById('totalInvestment').textContent} جنيه</p>
                    <p><strong>إيرادات السنة الأولى:</strong> ${document.getElementById('yearOneRevenue').textContent} جنيه</p>
                    <p><strong>صافي الربح:</strong> ${document.getElementById('yearOneProfit').textContent} جنيه</p>
                    <p><strong>نقطة التعادل:</strong> ${document.getElementById('breakEven').textContent} شهر</p>
                    <p><strong>العائد على الاستثمار:</strong> ${document.getElementById('roi').textContent}%</p>
                    
                    <h4>📈 توزيع الإيرادات</h4>
                    <p><strong>أضاحي:</strong> ${document.getElementById('udheyaRevenue').textContent} جنيه</p>
                    <p><strong>لحوم:</strong> ${document.getElementById('meatRevenue').textContent} جنيه</p>
                    <p><strong>حيوانات حية:</strong> ${document.getElementById('liveAnimalRevenue').textContent} جنيه</p>
                    <p><strong>كاترينج:</strong> ${document.getElementById('cateringRevenue').textContent} جنيه</p>
                    
                    <h4>💰 هيكل التكاليف</h4>
                    <p><strong>البنية التحتية:</strong> ${document.getElementById('infraTotal').textContent} جنيه</p>
                    <p><strong>القطيع:</strong> ${document.getElementById('flockTotal').textContent} جنيه</p>
                    <p><strong>رأس المال العامل:</strong> ${document.getElementById('workingCapital').textContent} جنيه</p>
                </div>
            `;
            document.getElementById('detailedReport').innerHTML = report;
        }
        
        function printReport() {
            const reportContent = document.getElementById('detailedReport').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>تقرير جدوى مشروع تربية الأغنام</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h4 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
                    </style>
                </head>
                <body>
                    <h2>🐑 تقرير جدوى مشروع تربية الأغنام</h2>
                    ${reportContent}
                    <hr>
                    <p style="font-size: 0.8em; color: #666; text-align: center;">
                        تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('ar-EG')}
                    </p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Chart Creation Functions
        function createCharts() {
            createCashFlowChart();
            createRevenueChart();
            createBreakEvenChart();
            createCostBreakdownChart();
        }
        
        function createCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            if (charts.cashFlow) {
                charts.cashFlow.destroy();
            }
            
            const monthlyRevenue = parseFloat(document.getElementById('yearOneRevenue').textContent.replace(/,/g, '')) / 12;
            const monthlyOperating = parseFloat(document.getElementById('monthlyOperating').textContent.replace(/,/g, ''));
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').textContent.replace(/,/g, ''));
            
            let cumulativeCash = -totalInvestment;
            const cashFlowData = [];
            
            for (let i = 1; i <= 12; i++) {
                const monthlyProfit = monthlyRevenue - monthlyOperating;
                cumulativeCash += monthlyProfit;
                cashFlowData.push(cumulativeCash);
            }
            
            charts.cashFlow = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                    datasets: [{
                        label: 'التدفق النقدي المتراكم',
                        data: cashFlowData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'تحليل التدفق النقدي (12 شهر)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' جنيه';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }
            
            const revenueData = [
                parseFloat(document.getElementById('udheyaRevenue').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('meatRevenue').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('liveAnimalRevenue').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('cateringRevenue').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('exportRevenue').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('manureRevenue').textContent.replace(/,/g, ''))
            ];
            
            charts.revenue = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['أضاحي', 'لحوم', 'حيوانات حية', 'كاترينج', 'تصدير', 'سماد'],
                    datasets: [{
                        data: revenueData,
                        backgroundColor: [
                            '#e74c3c',
                            '#3498db',
                            '#2ecc71',
                            '#f39c12',
                            '#9b59b6',
                            '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'توزيع مصادر الإيراد'
                        }
                    }
                }
            });
        }
        
        function createBreakEvenChart() {
            const ctx = document.getElementById('breakEvenChart');
            if (!ctx) return;
            
            if (charts.breakEven) {
                charts.breakEven.destroy();
            }
            
            const monthlyRevenue = parseFloat(document.getElementById('yearOneRevenue').textContent.replace(/,/g, '')) / 12;
            const monthlyOperating = parseFloat(document.getElementById('monthlyOperating').textContent.replace(/,/g, ''));
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').textContent.replace(/,/g, ''));
            
            const months = [];
            const cumulativeRevenue = [];
            const cumulativeCosts = [];
            
            let totalRev = 0;
            let totalCost = totalInvestment;
            
            for (let i = 1; i <= 24; i++) {
                months.push(i);
                totalRev += monthlyRevenue;
                totalCost += monthlyOperating;
                cumulativeRevenue.push(totalRev);
                cumulativeCosts.push(totalCost);
            }
            
            charts.breakEven = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'إجمالي الإيرادات',
                            data: cumulativeRevenue,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'إجمالي التكاليف',
                            data: cumulativeCosts,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'تحليل نقطة التعادل (24 شهر)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(1) + 'م جنيه';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'الشهر'
                            }
                        }
                    }
                }
            });
        }
        
        function createCostBreakdownChart() {
            const ctx = document.getElementById('costBreakdownChart');
            if (!ctx) return;
            
            if (charts.costBreakdown) {
                charts.costBreakdown.destroy();
            }
            
            const costData = [
                parseFloat(document.getElementById('infraTotal').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('flockTotal').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('workingCapital').textContent.replace(/,/g, '')),
                parseFloat(document.getElementById('monthlyOperating').textContent.replace(/,/g, '')) * 12
            ];
            
            charts.costBreakdown = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['البنية التحتية', 'القطيع', 'رأس المال', 'تشغيل سنوي'],
                    datasets: [{
                        label: 'التكلفة (جنيه)',
                        data: costData,
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#f39c12',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'توزيع التكاليف'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000).toFixed(0) + 'ألف';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Multi-year planning functions
        function calculateMultiYear() {
            const flockGrowth = parseFloat(document.getElementById('flockGrowthRate').value) || 25;
            const productivityGrowth = parseFloat(document.getElementById('productivityImprovement').value) || 5;
            const priceInflation = parseFloat(document.getElementById('priceInflation').value) || 8;
            const costInflation = parseFloat(document.getElementById('costInflation').value) || 6;
            
            const expansion2 = parseFloat(document.getElementById('expansion2').value) || 0;
            const expansion3 = parseFloat(document.getElementById('expansion3').value) || 0;
            const expansion5 = parseFloat(document.getElementById('expansion5').value) || 0;
            
            // Base year values
            const baseRevenue = parseFloat(document.getElementById('yearOneRevenue').textContent.replace(/,/g, ''));
            const baseCosts = parseFloat(document.getElementById('yearOneCosts').textContent.replace(/,/g, ''));
            const baseInvestment = parseFloat(document.getElementById('totalInvestment').textContent.replace(/,/g, ''));
            const baseFlock = parseFloat(document.getElementById('initialSheep').value);
            
            const projections = [];
            
            for (let year = 1; year <= 5; year++) {
                const flockSize = Math.round(baseFlock * Math.pow(1 + flockGrowth/100, year - 1));
                const revenue = baseRevenue * Math.pow(1 + priceInflation/100, year - 1) * Math.pow(1 + productivityGrowth/100, year - 1);
                const operatingCosts = (baseCosts - baseInvestment) * Math.pow(1 + costInflation/100, year - 1);
                
                let additionalInvestment = 0;
                if (year === 2) additionalInvestment = expansion2;
                if (year === 3) additionalInvestment = expansion3;
                if (year === 5) additionalInvestment = expansion5;
                
                const totalCosts = operatingCosts + additionalInvestment;
                const profit = revenue - totalCosts;
                const roi = baseInvestment > 0 ? (profit / baseInvestment * 100) : 0;
                
                projections.push({
                    year,
                    flockSize,
                    revenue: Math.round(revenue),
                    costs: Math.round(totalCosts),
                    profit: Math.round(profit),
                    roi: roi.toFixed(1),
                    investment: additionalInvestment
                });
            }
            
            updateMultiYearTable(projections);
            createMultiYearCharts(projections);
        }
        
        function updateMultiYearTable(projections) {
            const tbody = document.getElementById('fiveYearTableBody');
            if (!tbody) return;
            
            const rows = [
                ['عدد الأغنام', projections.map(p => p.flockSize.toLocaleString())],
                ['الإيرادات', projections.map(p => p.revenue.toLocaleString())],
                ['التكاليف', projections.map(p => p.costs.toLocaleString())],
                ['صافي الربح', projections.map(p => p.profit.toLocaleString())],
                ['العائد %', projections.map(p => p.roi + '%')],
                ['استثمارات إضافية', projections.map(p => p.investment.toLocaleString())]
            ];
            
            tbody.innerHTML = rows.map(([label, values]) => `
                <tr>
                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">${label}</td>
                    ${values.map(value => `<td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${value}</td>`).join('')}
                </tr>
            `).join('');
        }
        
        function createMultiYearCharts(projections) {
            createMultiYearRevenueChart(projections);
            createFlockGrowthChart(projections);
        }
        
        function createMultiYearRevenueChart(projections) {
            const ctx = document.getElementById('multiYearRevenueChart');
            if (!ctx) return;
            
            if (charts.multiYearRevenue) {
                charts.multiYearRevenue.destroy();
            }
            
            charts.multiYearRevenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: projections.map(p => `السنة ${p.year}`),
                    datasets: [
                        {
                            label: 'الإيرادات',
                            data: projections.map(p => p.revenue),
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'التكاليف',
                            data: projections.map(p => p.costs),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'صافي الربح',
                            data: projections.map(p => p.profit),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'الأداء المالي على 5 سنوات'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(1) + 'م';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createFlockGrowthChart(projections) {
            const ctx = document.getElementById('flockGrowthChart');
            if (!ctx) return;
            
            if (charts.flockGrowth) {
                charts.flockGrowth.destroy();
            }
            
            charts.flockGrowth = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: projections.map(p => `السنة ${p.year}`),
                    datasets: [{
                        label: 'عدد الأغنام',
                        data: projections.map(p => p.flockSize),
                        backgroundColor: '#9b59b6',
                        borderColor: '#8e44ad',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'نمو حجم القطيع'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' رأس';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Feed optimizer functions
        function optimizeFeed() {
            // Simple feed optimization algorithm
            const cornPrice = parseFloat(document.getElementById('cornPrice').value) || 8000;
            const soybeanPrice = parseFloat(document.getElementById('soybeanPrice').value) || 15000;
            const wheatBranPrice = parseFloat(document.getElementById('wheatBranPrice').value) || 6000;
            const barleyPrice = parseFloat(document.getElementById('barleyPrice').value) || 7000;
            const concentratePrice = parseFloat(document.getElementById('concentratePrice').value) || 12000;
            const alfalfaPrice = parseFloat(document.getElementById('alfalfaPrice').value) || 4000;
            
            const requiredProtein = parseFloat(document.getElementById('requiredProtein').value) || 16;
            const requiredEnergy = parseFloat(document.getElementById('requiredEnergy').value) || 2.8;
            const maxFiber = parseFloat(document.getElementById('maxFiber').value) || 18;
            
            // Feed components with nutritional values
            const feeds = {
                corn: { price: cornPrice, protein: 8, energy: 3.2, fiber: 2 },
                soybean: { price: soybeanPrice, protein: 44, energy: 2.2, fiber: 6 },
                wheatBran: { price: wheatBranPrice, protein: 15, energy: 2.0, fiber: 12 },
                barley: { price: barleyPrice, protein: 11, energy: 2.8, fiber: 5 },
                concentrate: { price: concentratePrice, protein: 18, energy: 2.7, fiber: 8 },
                alfalfa: { price: alfalfaPrice, protein: 17, energy: 2.2, fiber: 28 }
            };
            
            // Simple optimization (this is a simplified version)
            // In real implementation, you would use linear programming
            let bestCost = Infinity;
            let bestFormula = null;
            
            // Try different combinations
            for (let corn = 20; corn <= 50; corn += 5) {
                for (let soybean = 10; soybean <= 25; soybean += 5) {
                    for (let concentrate = 15; concentrate <= 35; concentrate += 5) {
                        const remaining = 100 - corn - soybean - concentrate;
                        if (remaining < 0) continue;
                        
                        const alfalfa = Math.min(remaining, 30);
                        const wheatBran = remaining - alfalfa;
                        
                        if (wheatBran < 0) continue;
                        
                        const formula = { corn, soybean, wheatBran, concentrate, alfalfa, barley: 0 };
                        
                        // Calculate nutritional values
                        let totalProtein = 0;
                        let totalEnergy = 0;
                        let totalFiber = 0;
                        let totalCost = 0;
                        
                        Object.entries(formula).forEach(([feed, percentage]) => {
                            const feedData = feeds[feed];
                            totalProtein += (percentage / 100) * feedData.protein;
                            totalEnergy += (percentage / 100) * feedData.energy;
                            totalFiber += (percentage / 100) * feedData.fiber;
                            totalCost += (percentage / 100) * feedData.price;
                        });
                        
                        // Check constraints
                        if (totalProtein >= requiredProtein && 
                            totalEnergy >= requiredEnergy && 
                            totalFiber <= maxFiber &&
                            totalCost < bestCost) {
                            bestCost = totalCost;
                            bestFormula = {
                                formula,
                                protein: totalProtein.toFixed(1),
                                energy: totalEnergy.toFixed(1),
                                fiber: totalFiber.toFixed(1),
                                cost: totalCost.toFixed(0)
                            };
                        }
                    }
                }
            }
            
            updateFeedFormula(bestFormula);
            createFeedCompositionChart(bestFormula);
        }
        
        function updateFeedFormula(formula) {
            const container = document.getElementById('optimalFormula');
            const costElement = document.getElementById('optimalCost');
            
            if (!formula) {
                container.innerHTML = '<p style="color: red;">لم يتم العثور على تركيبة مثلى تحقق المتطلبات</p>';
                costElement.textContent = 'غير محدد';
                return;
            }
            
            const feedNames = {
                corn: 'ذرة',
                soybean: 'كسب فول صويا',
                wheatBran: 'نخالة قمح',
                barley: 'شعير',
                concentrate: 'علف مركز',
                alfalfa: 'دريس برسيم'
            };
            
            const formulaHTML = Object.entries(formula.formula)
                .filter(([, percentage]) => percentage > 0)
                .map(([feed, percentage]) => 
                    `<div style="margin: 5px 0;"><strong>${feedNames[feed]}:</strong> ${percentage}%</div>`
                ).join('');
            
            container.innerHTML = `
                <div style="margin-bottom: 10px;">${formulaHTML}</div>
                <div style="background: #e8f4f8; padding: 8px; border-radius: 4px; font-size: 0.9em;">
                    <div><strong>البروتين:</strong> ${formula.protein}%</div>
                    <div><strong>الطاقة:</strong> ${formula.energy} ميجا كالوري/كجم</div>
                    <div><strong>الألياف:</strong> ${formula.fiber}%</div>
                </div>
            `;
            
            costElement.textContent = formula.cost;
        }
        
        function createFeedCompositionChart(formula) {
            const ctx = document.getElementById('feedCompositionChart');
            if (!ctx || !formula) return;
            
            if (charts.feedComposition) {
                charts.feedComposition.destroy();
            }
            
            const feedNames = {
                corn: 'ذرة',
                soybean: 'كسب فول صويا',
                wheatBran: 'نخالة قمح',
                barley: 'شعير',
                concentrate: 'علف مركز',
                alfalfa: 'دريس برسيم'
            };
            
            const data = Object.entries(formula.formula)
                .filter(([, percentage]) => percentage > 0)
                .map(([feed, percentage]) => ({ feed: feedNames[feed], percentage }));
            
            charts.feedComposition = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(d => d.feed),
                    datasets: [{
                        data: data.map(d => d.percentage),
                        backgroundColor: [
                            '#f39c12',
                            '#e74c3c',
                            '#3498db',
                            '#2ecc71',
                            '#9b59b6',
                            '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'تركيبة العلف المثلى'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Breeding calendar functions
        function generateBreedingCalendar() {
            const breeding1Start = new Date(document.getElementById('breeding1Start').value);
            const breeding2Start = new Date(document.getElementById('breeding2Start').value);
            const breedingDuration = parseInt(document.getElementById('breedingDuration').value) || 45;
            const gestationDays = parseInt(document.getElementById('gestationDays').value) || 150;
            const lactationDays = parseInt(document.getElementById('lactationPeriod').value) || 90;
            
            const events = [];
            
            // First breeding season
            events.push({
                date: new Date(breeding1Start),
                event: 'بداية موسم التلقيح الأول',
                type: 'breeding',
                priority: 'high'
            });
            
            const breeding1End = new Date(breeding1Start);
            breeding1End.setDate(breeding1End.getDate() + breedingDuration);
            events.push({
                date: new Date(breeding1End),
                event: 'نهاية موسم التلقيح الأول',
                type: 'breeding',
                priority: 'medium'
            });
            
            const birth1Start = new Date(breeding1Start);
            birth1Start.setDate(birth1Start.setDate() + gestationDays);
            events.push({
                date: new Date(birth1Start),
                event: 'بداية موسم الولادة الأول',
                type: 'birth',
                priority: 'high'
            });
            
            const weaning1 = new Date(birth1Start);
            weaning1.setDate(weaning1.getDate() + lactationDays);
            events.push({
                date: new Date(weaning1),
                event: 'فطام مجموعة 1',
                type: 'weaning',
                priority: 'medium'
            });
            
            // Second breeding season
            events.push({
                date: new Date(breeding2Start),
                event: 'بداية موسم التلقيح الثاني',
                type: 'breeding',
                priority: 'high'
            });
            
            const birth2Start = new Date(breeding2Start);
            birth2Start.setDate(birth2Start.getDate() + gestationDays);
            events.push({
                date: new Date(birth2Start),
                event: 'بداية موسم الولادة الثاني',
                type: 'birth',
                priority: 'high'
            });
            
            // Sort events by date
            events.sort((a, b) => a.date - b.date);
            
            displayBreedingSchedule(events);
            createProductionTimelineChart(events);
        }
        
        function displayBreedingSchedule(events) {
            const container = document.getElementById('breedingSchedule');
            if (!container) return;
            
            const eventIcons = {
                breeding: '🐑',
                birth: '🐣',
                weaning: '🌿'
            };
            
            const eventColors = {
                high: '#e74c3c',
                medium: '#f39c12',
                low: '#2ecc71'
            };
            
            const eventsHTML = events.map(event => {
                const dateStr = event.date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                return `
                    <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 4px solid ${eventColors[event.priority]};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${eventIcons[event.type]} ${event.event}</span>
                            <span style="color: #666; font-size: 0.9em;">${dateStr}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #2c3e50;">الأحداث القادمة:</h4>
                ${eventsHTML}
            `;
        }
        
        function createProductionTimelineChart(events) {
            const ctx = document.getElementById('productionTimelineChart');
            if (!ctx) return;
            
            if (charts.productionTimeline) {
                charts.productionTimeline.destroy();
            }
            
            // Create monthly production data
            const monthlyData = Array(12).fill(0);
            const ewes = parseInt(document.getElementById('ewes').value) || 30;
            const birthRate = parseFloat(document.getElementById('birthRate').value) || 150;
            const lambsPerBirth = parseFloat(document.getElementById('lambsPerBirth').value) || 1.3;
            
            events.filter(e => e.type === 'birth').forEach(event => {
                const month = event.date.getMonth();
                const expectedLambs = ewes * (birthRate / 100) * lambsPerBirth;
                monthlyData[month] += expectedLambs;
            });
            
            charts.productionTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                    datasets: [{
                        label: 'عدد المواليد المتوقعة',
                        data: monthlyData,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'توزيع المواليد على مدار العام'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Math.round(value) + ' مولود';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Sensitivity analysis functions
        function runSensitivityAnalysis() {
            const priceVar = parseFloat(document.getElementById('priceVariation').value) || 20;
            const feedCostVar = parseFloat(document.getElementById('feedCostVariation').value) || 25;
            const birthRateVar = parseFloat(document.getElementById('birthRateVariation').value) || 15;
            const mortalityVar = parseFloat(document.getElementById('mortalityVariation').value) || 10;
            const demandVar = parseFloat(document.getElementById('demandVariation').value) || 30;
            const monteCarloRuns = parseInt(document.getElementById('monteCarloRuns').value) || 1000;
            
            // Base values
            const baseProfit = parseFloat(document.getElementById('yearOneProfit').textContent.replace(/,/g, ''));
            const basePrice = parseFloat(document.getElementById('udheyaPrice').value);
            const baseFeedCost = parseFloat(document.getElementById('feedPriceTon').value);
            const baseBirthRate = parseFloat(document.getElementById('birthRate').value);
            const baseMortality = parseFloat(document.getElementById('mortalityRate').value);
            const baseDemand = parseFloat(document.getElementById('udheyaCustomers').value);
            
            // Tornado analysis
            const sensitivities = [];
            
            // Price sensitivity
            const highPrice = calculateSensitivityProfit('udheyaPrice', basePrice * (1 + priceVar/100));
            const lowPrice = calculateSensitivityProfit('udheyaPrice', basePrice * (1 - priceVar/100));
            sensitivities.push({
                variable: 'أسعار البيع',
                high: highPrice - baseProfit,
                low: lowPrice - baseProfit
            });
            
            // Feed cost sensitivity
            const highFeedCost = calculateSensitivityProfit('feedPriceTon', baseFeedCost * (1 + feedCostVar/100));
            const lowFeedCost = calculateSensitivityProfit('feedPriceTon', baseFeedCost * (1 - feedCostVar/100));
            sensitivities.push({
                variable: 'تكاليف العلف',
                high: highFeedCost - baseProfit,
                low: lowFeedCost - baseProfit
            });
            
            // Birth rate sensitivity
            const highBirthRate = calculateSensitivityProfit('birthRate', baseBirthRate * (1 + birthRateVar/100));
            const lowBirthRate = calculateSensitivityProfit('birthRate', baseBirthRate * (1 - birthRateVar/100));
            sensitivities.push({
                variable: 'معدل الولادة',
                high: highBirthRate - baseProfit,
                low: lowBirthRate - baseProfit
            });
            
            // Demand sensitivity
            const highDemand = calculateSensitivityProfit('udheyaCustomers', baseDemand * (1 + demandVar/100));
            const lowDemand = calculateSensitivityProfit('udheyaCustomers', baseDemand * (1 - demandVar/100));
            sensitivities.push({
                variable: 'الطلب',
                high: highDemand - baseProfit,
                low: lowDemand - baseProfit
            });
            
            // Run Monte Carlo simulation
            const monteCarloResults = runMonteCarloSimulation(monteCarloRuns, {
                priceVar, feedCostVar, birthRateVar, mortalityVar, demandVar
            });
            
            // Display results
            createSensitivityChart(sensitivities);
            createMonteCarloChart(monteCarloResults);
            displayRiskAssessment(monteCarloResults, baseProfit);
        }
        
        function calculateSensitivityProfit(variableId, newValue) {
            const originalValue = document.getElementById(variableId).value;
            document.getElementById(variableId).value = newValue;
            calculateAll();
            const profit = parseFloat(document.getElementById('yearOneProfit').textContent.replace(/,/g, ''));
            document.getElementById(variableId).value = originalValue;
            calculateAll();
            return profit;
        }
        
        function runMonteCarloSimulation(runs, variations) {
            const results = [];
            const baseValues = {
                udheyaPrice: parseFloat(document.getElementById('udheyaPrice').value),
                feedPriceTon: parseFloat(document.getElementById('feedPriceTon').value),
                birthRate: parseFloat(document.getElementById('birthRate').value),
                mortalityRate: parseFloat(document.getElementById('mortalityRate').value),
                udheyaCustomers: parseFloat(document.getElementById('udheyaCustomers').value)
            };
            
            for (let i = 0; i < runs; i++) {
                // Generate random variations
                const priceMultiplier = 1 + (Math.random() - 0.5) * 2 * (variations.priceVar / 100);
                const feedCostMultiplier = 1 + (Math.random() - 0.5) * 2 * (variations.feedCostVar / 100);
                const birthRateMultiplier = 1 + (Math.random() - 0.5) * 2 * (variations.birthRateVar / 100);
                const mortalityMultiplier = 1 + (Math.random() - 0.5) * 2 * (variations.mortalityVar / 100);
                const demandMultiplier = 1 + (Math.random() - 0.5) * 2 * (variations.demandVar / 100);
                
                // Apply variations
                document.getElementById('udheyaPrice').value = baseValues.udheyaPrice * priceMultiplier;
                document.getElementById('feedPriceTon').value = baseValues.feedPriceTon * feedCostMultiplier;
                document.getElementById('birthRate').value = baseValues.birthRate * birthRateMultiplier;
                document.getElementById('mortalityRate').value = Math.max(0, baseValues.mortalityRate * mortalityMultiplier);
                document.getElementById('udheyaCustomers').value = Math.max(0, baseValues.udheyaCustomers * demandMultiplier);
                
                calculateAll();
                const profit = parseFloat(document.getElementById('yearOneProfit').textContent.replace(/,/g, ''));
                results.push(profit);
            }
            
            // Restore original values
            Object.entries(baseValues).forEach(([id, value]) => {
                document.getElementById(id).value = value;
            });
            calculateAll();
            
            return results;
        }
        
        function createSensitivityChart(sensitivities) {
            const ctx = document.getElementById('sensitivityChart');
            if (!ctx) return;
            
            if (charts.sensitivity) {
                charts.sensitivity.destroy();
            }
            
            const data = sensitivities.map(s => [s.low, s.high]);
            const labels = sensitivities.map(s => s.variable);
            
            charts.sensitivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'تأثير سلبي',
                            data: sensitivities.map(s => s.low),
                            backgroundColor: '#e74c3c'
                        },
                        {
                            label: 'تأثير إيجابي',
                            data: sensitivities.map(s => s.high),
                            backgroundColor: '#2ecc71'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'تحليل الحساسية (رسم الإعصار)'
                        }
                    },
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000).toFixed(0) + 'ألف';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createMonteCarloChart(results) {
            const ctx = document.getElementById('monteCarloChart');
            if (!ctx) return;
            
            if (charts.monteCarlo) {
                charts.monteCarlo.destroy();
            }
            
            // Create histogram
            const bins = 20;
            const min = Math.min(...results);
            const max = Math.max(...results);
            const binSize = (max - min) / bins;
            const histogram = Array(bins).fill(0);
            const labels = [];
            
            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binSize;
                const binEnd = binStart + binSize;
                labels.push((binStart / 1000).toFixed(0) + '-' + (binEnd / 1000).toFixed(0));
                
                results.forEach(result => {
                    if (result >= binStart && result < binEnd) {
                        histogram[i]++;
                    }
                });
            }
            
            charts.monteCarlo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تكرار النتائج',
                        data: histogram,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'محاكاة مونت كارلو - توزيع الأرباح'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'صافي الربح (ألف جنيه)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'عدد مرات الحدوث'
                            }
                        }
                    }
                }
            });
        }
        
        function displayRiskAssessment(results, baseProfit) {
            const container = document.getElementById('riskAssessment');
            if (!container) return;
            
            const profitable = results.filter(r => r > 0).length;
            const profitabilityPercentage = (profitable / results.length * 100).toFixed(1);
            
            const mean = results.reduce((sum, r) => sum + r, 0) / results.length;
            const sorted = results.sort((a, b) => a - b);
            const percentile5 = sorted[Math.floor(results.length * 0.05)];
            const percentile95 = sorted[Math.floor(results.length * 0.95)];
            const median = sorted[Math.floor(results.length * 0.5)];
            
            const worstCase = Math.min(...results);
            const bestCase = Math.max(...results);
            
            let riskLevel = 'منخفض';
            let riskColor = '#2ecc71';
            
            if (profitabilityPercentage < 60) {
                riskLevel = 'عالي';
                riskColor = '#e74c3c';
            } else if (profitabilityPercentage < 80) {
                riskLevel = 'متوسط';
                riskColor = '#f39c12';
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid ${riskColor};">
                        <h4 style="color: ${riskColor}; margin-bottom: 8px;">مستوى المخاطرة: ${riskLevel}</h4>
                        <p>نسبة الربحية: ${profitabilityPercentage}%</p>
                    </div>
                    
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <h4 style="color: #2c3e50; margin-bottom: 8px;">القيم المتوقعة</h4>
                        <p>المتوسط: ${mean.toLocaleString()} جنيه</p>
                        <p>الوسيط: ${median.toLocaleString()} جنيه</p>
                    </div>
                    
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <h4 style="color: #2c3e50; margin-bottom: 8px;">نطاق الثقة (90%)</h4>
                        <p>الحد الأدنى: ${percentile5.toLocaleString()}</p>
                        <p>الحد الأعلى: ${percentile95.toLocaleString()}</p>
                    </div>
                    
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <h4 style="color: #2c3e50; margin-bottom: 8px;">السيناريوهات المتطرفة</h4>
                        <p style="color: #e74c3c;">الأسوأ: ${worstCase.toLocaleString()}</p>
                        <p style="color: #2ecc71;">الأفضل: ${bestCase.toLocaleString()}</p>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 6px;">
                    <h4 style="color: #2c3e50; margin-bottom: 8px;">توصيات إدارة المخاطر:</h4>
                    <ul style="margin: 0; padding-right: 20px;">
                        ${profitabilityPercentage < 70 ? '<li>اعتبر زيادة الاحتياطيات النقدية</li>' : ''}
                        <li>مراقبة أسعار العلف بانتظام</li>
                        <li>تنويع مصادر الإيرادات</li>
                        <li>وضع خطة للطوارئ البيطرية</li>
                        ${profitabilityPercentage > 85 ? '<li style="color: #2ecc71;">المشروع يظهر مخاطر منخفضة وربحية عالية</li>' : ''}
                    </ul>
                </div>
            `;
        }
        
        // Market Intelligence Functions
        function createPriceTrendsChart() {
            const ctx = document.getElementById('priceTrendsChart');
            if (!ctx) return;
            
            if (charts.priceeTrends) {
                charts.priceTrends.destroy();
            }
            
            const price2021 = parseFloat(document.getElementById('price2021').value) || 6500;
            const price2022 = parseFloat(document.getElementById('price2022').value) || 7000;
            const price2023 = parseFloat(document.getElementById('price2023').value) || 7500;
            const currentPrice = parseFloat(document.getElementById('udheyaPrice').value) || 8000;
            
            // Generate seasonal pattern
            const basePrice = currentPrice;
            const ramadanIncrease = parseFloat(document.getElementById('ramadanPriceIncrease').value) || 15;
            const hajjIncrease = parseFloat(document.getElementById('hajjPriceIncrease').value) || 25;
            const summerDecrease = parseFloat(document.getElementById('summerPriceDecrease').value) || 10;
            
            const monthlyPrices = [
                basePrice * (1 - summerDecrease/100), // Jan
                basePrice * (1 - summerDecrease/100), // Feb
                basePrice, // Mar
                basePrice * (1 + ramadanIncrease/100), // Apr (Ramadan)
                basePrice, // May
                basePrice * (1 - summerDecrease/100), // Jun
                basePrice * (1 + hajjIncrease/100), // Jul (Hajj)
                basePrice, // Aug
                basePrice, // Sep
                basePrice, // Oct
                basePrice, // Nov
                basePrice * (1 + hajjIncrease/100) // Dec (Hajj)
            ];
            
            charts.priceTrends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                    datasets: [
                        {
                            label: '2021',
                            data: monthlyPrices.map(p => price2021 * (p / basePrice)),
                            borderColor: '#95a5a6',
                            backgroundColor: 'rgba(149, 165, 166, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '2022',
                            data: monthlyPrices.map(p => price2022 * (p / basePrice)),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '2023',
                            data: monthlyPrices.map(p => price2023 * (p / basePrice)),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '2024 (توقع)',
                            data: monthlyPrices,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'اتجاهات أسعار الأضاحي'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' جنيه';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createDemandForecastChart() {
            const ctx = document.getElementById('demandForecastChart');
            if (!ctx) return;
            
            if (charts.demandForecast) {
                charts.demandForecast.destroy();
            }
            
            const totalFamilies = parseFloat(document.getElementById('totalFamilies').value) || 5000;
            const sacrificePercentage = parseFloat(document.getElementById('sacrificePercentage').value) || 70;
            const populationGrowth = parseFloat(document.getElementById('populationGrowth').value) || 2.5;
            const purchasingPowerGrowth = parseFloat(document.getElementById('purchasingPowerGrowth').value) || 5;
            
            const currentDemand = totalFamilies * (sacrificePercentage / 100);
            const years = ['2024', '2025', '2026', '2027', '2028'];
            const demandProjection = [];
            
            for (let i = 0; i < 5; i++) {
                const populationFactor = Math.pow(1 + populationGrowth/100, i);
                const purchasingFactor = Math.pow(1 + purchasingPowerGrowth/100, i);
                const demand = currentDemand * populationFactor * Math.min(purchasingFactor, 1.3); // Cap purchasing power effect
                demandProjection.push(Math.round(demand));
            }
            
            charts.demandForecast = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'الطلب المتوقع',
                        data: demandProjection,
                        backgroundColor: '#9b59b6',
                        borderColor: '#8e44ad',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'توقع الطلب على الأضاحي'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' أضحية';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Compliance Functions
        function initializeCompliance() {
            const basicDocs = [
                { name: 'السجل التجاري', completed: false, cost: 2000, renewal: 'سنوي' },
                { name: 'البطاقة الضريبية', completed: false, cost: 500, renewal: 'مرة واحدة' },
                { name: 'رخصة مزاولة النشاط', completed: false, cost: 5000, renewal: 'سنوي' },
                { name: 'ترخيص بيئي', completed: false, cost: 8000, renewal: '3 سنوات' },
                { name: 'رخصة بناء', completed: false, cost: 15000, renewal: 'مرة واحدة' }
            ];
            
            const qualityDocs = [
                { name: 'شهادة الذبح الحلال', completed: false, cost: 15000, renewal: 'سنوي' },
                { name: 'ISO 22000', completed: false, cost: 50000, renewal: '3 سنوات' },
                { name: 'شهادة HACCP', completed: false, cost: 25000, renewal: 'سنوي' },
                { name: 'ترخيص وزارة الصحة', completed: false, cost: 10000, renewal: 'سنوي' },
                { name: 'شهادة جودة مصرية', completed: false, cost: 20000, renewal: '3 سنوات' }
            ];
            
            const exportDocs = [
                { name: 'رخصة تصدير', completed: false, cost: 25000, renewal: 'سنوي' },
                { name: 'شهادة منشأ مصري', completed: false, cost: 5000, renewal: 'لكل شحنة' },
                { name: 'شهادة بيطرية', completed: false, cost: 3000, renewal: 'لكل شحنة' },
                { name: 'ترخيص جمارك', completed: false, cost: 8000, renewal: 'سنوي' },
                { name: 'شهادة مطابقة خليجية', completed: false, cost: 15000, renewal: 'سنوي' }
            ];
            
            displayDocumentChecklist('basicDocuments', basicDocs);
            displayDocumentChecklist('qualityDocuments', qualityDocs);
            displayDocumentChecklist('exportDocuments', exportDocs);
            
            updateComplianceChart();
        }
        
        function displayDocumentChecklist(containerId, documents) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = documents.map((doc, index) => `
                <div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" onchange="toggleDocumentStatus('${containerId}', ${index})" style="margin: 0;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 0.8em;">${doc.name}</div>
                            <div style="font-size: 0.7em; color: #666;">${doc.cost.toLocaleString()} جنيه - ${doc.renewal}</div>
                        </div>
                    </label>
                </div>
            `).join('');
        }
        
        function toggleDocumentStatus(containerId, index) {
            // This would update the document status in a real application
            updateComplianceChart();
        }
        
        function updateComplianceChart() {
            const ctx = document.getElementById('complianceChart');
            if (!ctx) return;
            
            if (charts.compliance) {
                charts.compliance.destroy();
            }
            
            // Count completed documents (this would be dynamic in a real app)
            const totalDocs = 15;
            const completedDocs = Math.floor(Math.random() * 8) + 3; // Simulate some completed
            const pendingDocs = totalDocs - completedDocs;
            
            charts.compliance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['مكتمل', 'معلق'],
                    datasets: [{
                        data: [completedDocs, pendingDocs],
                        backgroundColor: ['#2ecc71', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'حالة الوثائق'
                        }
                    }
                }
            });
            
            // Update summary
            const summary = document.getElementById('complianceSummary');
            if (summary) {
                const completionRate = (completedDocs / totalDocs * 100).toFixed(1);
                summary.innerHTML = `
                    <div style="margin: 5px 0;"><strong>نسبة الإنجاز:</strong> ${completionRate}%</div>
                    <div style="margin: 5px 0;"><strong>مكتمل:</strong> ${completedDocs} من ${totalDocs}</div>
                    <div style="margin: 5px 0;"><strong>متبقي:</strong> ${pendingDocs} وثيقة</div>
                    <div style="margin: 10px 0; padding: 8px; background: ${completionRate > 80 ? '#d4edda' : completionRate > 60 ? '#fff3cd' : '#f8d7da'}; border-radius: 4px; font-size: 0.8em;">
                        ${completionRate > 80 ? '✅ مستوى ممتاز من الالتزام' : 
                          completionRate > 60 ? '⚠️ يحتاج إلى تحسين' : 
                          '❌ يتطلب عمل فوري'}
                    </div>
                `;
            }
        }
        
        // Operational Tools Functions
        function simulateOutbreak() {
            const diseaseType = document.getElementById('diseaseType').value;
            const infectionRate = parseFloat(document.getElementById('infectionRate').value) || 30;
            const diseaseMortality = parseFloat(document.getElementById('diseaseMortality').value) || 15;
            const treatmentCost = parseFloat(document.getElementById('treatmentCost').value) || 500;
            const weightLoss = parseFloat(document.getElementById('weightLoss').value) || 20;
            const flockSize = parseFloat(document.getElementById('initialSheep').value) || 50;
            const animalValue = parseFloat(document.getElementById('sheepCost').value) || 3500;
            
            const infectedAnimals = Math.round(flockSize * infectionRate / 100);
            const deaths = Math.round(infectedAnimals * diseaseMortality / 100);
            const recoveredAnimals = infectedAnimals - deaths;
            
            const treatmentCosts = infectedAnimals * treatmentCost;
            const mortalityLoss = deaths * animalValue;
            const weightLossValue = recoveredAnimals * animalValue * (weightLoss / 100);
            const totalLoss = treatmentCosts + mortalityLoss + weightLossValue;
            
            const diseaseNames = {
                ppr: 'طاعون المجترات الصغيرة',
                fmd: 'الحمى القلاعية',
                parasites: 'الطفيليات',
                respiratory: 'أمراض تنفسية'
            };
            
            const results = document.getElementById('outbreakResults');
            results.innerHTML = `
                <h4>تأثير تفشي ${diseaseNames[diseaseType]}:</h4>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>عدد الحيوانات المصابة:</strong> ${infectedAnimals} (${infectionRate}%)
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>عدد النفوق:</strong> ${deaths} رأس
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>تكلفة العلاج:</strong> ${treatmentCosts.toLocaleString()} جنيه
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>خسائر النفوق:</strong> ${mortalityLoss.toLocaleString()} جنيه
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>خسائر فقدان الوزن:</strong> ${weightLossValue.toLocaleString()} جنيه
                </div>
                <div style="margin: 8px 0; padding: 8px; background: #f8d7da; border-radius: 4px; font-weight: bold; color: #721c24;">
                    <strong>إجمالي الخسائر:</strong> ${totalLoss.toLocaleString()} جنيه
                </div>
                <div style="margin: 8px 0; padding: 6px; background: #e8f4f8; border-radius: 4px; font-size: 0.8em;">
                    <strong>التوصيات:</strong>
                    <ul style="margin: 5px 0; padding-right: 15px;">
                        <li>زيادة برنامج التحصينات الوقائية</li>
                        <li>تحسين النظافة والتطهير</li>
                        <li>زيادة الاحتياطي النقدي بـ${Math.round(totalLoss * 0.1).toLocaleString()} جنيه</li>
                    </ul>
                </div>
            `;
        }
        
        function optimizeSchedule() {
            const dailyHours = parseFloat(document.getElementById('dailyWorkHours').value) || 8;
            const workDays = parseFloat(document.getElementById('workDaysPerWeek').value) || 6;
            const workers = parseFloat(document.getElementById('workers').value) || 2;
            const workerSalary = parseFloat(document.getElementById('workerSalary').value) || 3000;
            const overtimeRate = parseFloat(document.getElementById('overtimeRate').value) || 50;
            
            const weeklyHours = dailyHours * workDays;
            const monthlyHours = weeklyHours * 4.33;
            const overtimeThreshold = 48; // Egyptian labor law
            const overtimeHours = Math.max(0, weeklyHours - overtimeThreshold);
            
            const regularPay = workerSalary;
            const overtimePay = (workerSalary / (overtimeThreshold * 4.33)) * overtimeHours * 4.33 * (1 + overtimeRate/100);
            const totalMonthlyCost = (regularPay + overtimePay) * workers;
            
            const efficiency = Math.min(100, (weeklyHours / 60) * 100); // Optimal around 60 hours/week
            
            const results = document.getElementById('scheduleResults');
            results.innerHTML = `
                <h4>تحليل جدولة العمل:</h4>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>ساعات العمل الأسبوعية:</strong> ${weeklyHours} ساعة
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>ساعات إضافية:</strong> ${overtimeHours.toFixed(1)} ساعة/أسبوع
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>التكلفة الشهرية:</strong> ${totalMonthlyCost.toLocaleString()} جنيه
                </div>
                <div style="margin: 8px 0; padding: 6px; background: white; border-radius: 4px;">
                    <strong>كفاءة الجدولة:</strong> ${efficiency.toFixed(1)}%
                </div>
                <div style="margin: 8px 0; padding: 6px; background: ${efficiency > 85 ? '#d4edda' : efficiency > 70 ? '#fff3cd' : '#f8d7da'}; border-radius: 4px; font-size: 0.8em;">
                    ${efficiency > 85 ? '✅ جدولة مثلى' : 
                      efficiency > 70 ? '⚠️ يمكن تحسينها' : 
                      '❌ تحتاج إعادة تنظيم'}
                </div>
            `;
        }
        
        function updateCurrencyConverter() {
            const egpAmount = parseFloat(document.getElementById('egpAmount').value) || 0;
            const usdRate = parseFloat(document.getElementById('usdRate').value) || 31;
            const eurRate = parseFloat(document.getElementById('eurRate').value) || 33;
            
            document.getElementById('usdAmount').value = (egpAmount / usdRate).toFixed(2);
            document.getElementById('eurAmount').value = (egpAmount / eurRate).toFixed(2);
        }
        
        // Initialize currency converter
        ['egpAmount', 'usdRate', 'eurRate'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateCurrencyConverter);
        });
        
        // Initial calculation
        calculateAll();
        
        // Update non-Eid sales when Eid sales changes
        document.getElementById('eidSales').addEventListener('input', function() {
            document.getElementById('nonEidSales').value = 100 - this.value;
        });
        
        // Update credit customers when cash customers changes
        document.getElementById('cashCustomers').addEventListener('input', function() {
            document.getElementById('creditCustomers').value = 100 - this.value;
        });
        
        // Update rams needed when ewes changes
        document.getElementById('ewes').addEventListener('input', function() {
            document.getElementById('ramsNeeded').value = Math.ceil(this.value / 25);
        });
    </script>
</body>
</html>
